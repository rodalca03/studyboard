<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#6366f1" />
  <meta name="description" content="Gestor de asignaturas, notas y horarios universitarios" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="StudyBoard" />
  <title>StudyBoard - Gestor de Asignaturas</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Crect width='32' height='32' rx='6' fill='%236366f1'/%3E%3Ctext x='16' y='24' font-size='20' text-anchor='middle'%3EğŸ“š%3C/text%3E%3C/svg%3E" />
  <link rel="apple-touch-icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='40' fill='url(%23g)'/%3E%3Ctext x='90' y='120' font-family='Arial' font-size='90' text-anchor='middle' fill='white'%3EğŸ“š%3C/text%3E%3C/svg%3E" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>

  <!-- Modal de Onboarding/Tutorial -->
  <div id="onboarding-modal" class="onboarding-overlay" style="display:none;">
    <div class="onboarding-container">
      <button class="onboarding-close" id="skip-onboarding">âœ•</button>

      <div class="onboarding-slides">
        <!-- Slide 1: Bienvenida -->
        <div class="onboarding-slide active">
          <div class="onboarding-image">
            <svg width="200" height="160" viewBox="0 0 200 160" fill="none">
              <rect x="20" y="20" width="160" height="120" rx="12" fill="#6366f1" opacity="0.1" />
              <rect x="30" y="30" width="140" height="100" rx="8" fill="#6366f1" opacity="0.2" />
              <text x="100" y="90" text-anchor="middle" font-size="64" fill="#6366f1">ğŸ“š</text>
            </svg>
          </div>
          <h2>Â¡Bienvenido a StudyBoard!</h2>
          <p>Tu gestor completo de asignaturas, notas y exÃ¡menes universitarios. Descubre las funcionalidades
            principales.</p>
        </div>

        <!-- Slide 2: Cuatrimestres y Asignaturas -->
        <div class="onboarding-slide">
          <div class="onboarding-image">
            <svg width="200" height="160" viewBox="0 0 200 160" fill="none">
              <rect x="15" y="15" width="70" height="50" rx="8" fill="#ff4d4d" opacity="0.8" />
              <rect x="95" y="15" width="70" height="50" rx="8" fill="#ff954d" opacity="0.8" />
              <rect x="15" y="75" width="70" height="50" rx="8" fill="#ffe14d" opacity="0.8" />
              <rect x="95" y="75" width="70" height="50" rx="8" fill="#9cff4d" opacity="0.8" />
              <text x="50" y="45" text-anchor="middle" font-size="20">ğŸ“–</text>
              <text x="130" y="45" text-anchor="middle" font-size="20">ğŸ“</text>
              <text x="50" y="105" text-anchor="middle" font-size="20">ğŸ“</text>
              <text x="130" y="105" text-anchor="middle" font-size="20">ğŸ”¬</text>
            </svg>
          </div>
          <h2>Organiza tus Cuatrimestres</h2>
          <p>Crea cuatrimestres y aÃ±ade todas tus asignaturas. Personaliza cada tarjeta con colores para identificarlas
            rÃ¡pidamente.</p>
        </div>

        <!-- Slide 3: Notas y Pruebas -->
        <div class="onboarding-slide">
          <div class="onboarding-image">
            <svg width="200" height="160" viewBox="0 0 200 160" fill="none">
              <rect x="40" y="20" width="120" height="120" rx="12" fill="#6366f1" opacity="0.1" />
              <line x1="60" y1="50" x2="140" y2="50" stroke="#6366f1" stroke-width="3" stroke-linecap="round" />
              <line x1="60" y1="75" x2="140" y2="75" stroke="#6366f1" stroke-width="3" stroke-linecap="round" />
              <line x1="60" y1="100" x2="140" y2="100" stroke="#6366f1" stroke-width="3" stroke-linecap="round" />
              <circle cx="150" cy="35" r="15" fill="#10b981" />
              <text x="150" y="42" text-anchor="middle" font-size="18" fill="white" font-weight="bold">8.5</text>
            </svg>
          </div>
          <h2>Gestiona tus Notas</h2>
          <p>AÃ±ade pruebas evaluables con su ponderaciÃ³n. StudyBoard calcularÃ¡ automÃ¡ticamente tu nota final y te
            mostrarÃ¡ quÃ© necesitas para aprobar.</p>
        </div>

        <!-- Slide 4: Gestos Swipe -->
        <div class="onboarding-slide">
          <div class="onboarding-image">
            <svg width="200" height="160" viewBox="0 0 200 160" fill="none">
              <!-- Tarjeta superior - Swipe izquierda (Eliminar) -->
              <g id="card-left">
                <rect x="60" y="30" width="80" height="50" rx="8" fill="white" stroke="#e2e8f0" stroke-width="2">
                  <animate attributeName="x" values="60;20;60" dur="3s" repeatCount="indefinite" />
                </rect>
                <line x1="70" y1="45" x2="130" y2="45" stroke="#cbd5e1" stroke-width="2">
                  <animate attributeName="x1" values="70;30;70" dur="3s" repeatCount="indefinite" />
                  <animate attributeName="x2" values="130;90;130" dur="3s" repeatCount="indefinite" />
                </line>
                <line x1="70" y1="55" x2="110" y2="55" stroke="#cbd5e1" stroke-width="2">
                  <animate attributeName="x1" values="70;30;70" dur="3s" repeatCount="indefinite" />
                  <animate attributeName="x2" values="110;70;110" dur="3s" repeatCount="indefinite" />
                </line>
                <line x1="70" y1="65" x2="120" y2="65" stroke="#cbd5e1" stroke-width="2">
                  <animate attributeName="x1" values="70;30;70" dur="3s" repeatCount="indefinite" />
                  <animate attributeName="x2" values="120;80;120" dur="3s" repeatCount="indefinite" />
                </line>
              </g>
              <!-- Fondo rojo "Eliminar" -->
              <rect x="20" y="30" width="120" height="50" rx="8" fill="#ef4444">
                <animate attributeName="opacity" values="0;0.8;0" dur="3s" repeatCount="indefinite" />
              </rect>
              <text x="30" y="60" font-size="14" fill="white" font-weight="bold">
                ğŸ—‘ï¸ Eliminar
                <animate attributeName="opacity" values="0;1;0" dur="3s" repeatCount="indefinite" />
              </text>

              <!-- Tarjeta inferior - Swipe derecha (InformaciÃ³n) -->
              <g id="card-right">
                <rect x="60" y="95" width="80" height="50" rx="8" fill="white" stroke="#e2e8f0" stroke-width="2">
                  <animate attributeName="x" values="60;100;60" dur="3s" repeatCount="indefinite" begin="1.5s" />
                </rect>
                <line x1="70" y1="110" x2="130" y2="110" stroke="#cbd5e1" stroke-width="2">
                  <animate attributeName="x1" values="70;110;70" dur="3s" repeatCount="indefinite" begin="1.5s" />
                  <animate attributeName="x2" values="130;170;130" dur="3s" repeatCount="indefinite" begin="1.5s" />
                </line>
                <line x1="70" y1="120" x2="110" y2="120" stroke="#cbd5e1" stroke-width="2">
                  <animate attributeName="x1" values="70;110;70" dur="3s" repeatCount="indefinite" begin="1.5s" />
                  <animate attributeName="x2" values="110;150;110" dur="3s" repeatCount="indefinite" begin="1.5s" />
                </line>
                <line x1="70" y1="130" x2="120" y2="130" stroke="#cbd5e1" stroke-width="2">
                  <animate attributeName="x1" values="70;110;70" dur="3s" repeatCount="indefinite" begin="1.5s" />
                  <animate attributeName="x2" values="120;160;120" dur="3s" repeatCount="indefinite" begin="1.5s" />
                </line>
              </g>
              <!-- Fondo azul "InformaciÃ³n" -->
              <rect x="60" y="95" width="120" height="50" rx="8" fill="#3b82f6">
                <animate attributeName="opacity" values="0;0.8;0" dur="3s" repeatCount="indefinite" begin="1.5s" />
              </rect>
              <text x="125" y="125" font-size="14" fill="white" font-weight="bold">
                â„¹ï¸ Info
                <animate attributeName="opacity" values="0;1;0" dur="3s" repeatCount="indefinite" begin="1.5s" />
              </text>
            </svg>
          </div>
          <h2>Gestos RÃ¡pidos</h2>
          <p>Desliza a la izquierda para eliminar una asignatura o a la derecha para ver su informaciÃ³n completa.
            Â¡RÃ¡pido y fÃ¡cil!</p>
        </div>

        <!-- Slide 5: SincronizaciÃ³n -->
        <div class="onboarding-slide">
          <div class="onboarding-image">
            <svg width="200" height="160" viewBox="0 0 200 160" fill="none">
              <circle cx="100" cy="80" r="50" fill="#4285f4" opacity="0.1" />
              <circle cx="100" cy="80" r="35" fill="#4285f4" opacity="0.2" />
              <text x="100" y="95" text-anchor="middle" font-size="48" fill="#4285f4">â˜ï¸</text>
              <circle cx="60" cy="130" r="12" fill="#34a853" />
              <circle cx="140" cy="130" r="12" fill="#34a853" />
              <text x="60" y="137" text-anchor="middle" font-size="14" fill="white">ğŸ“±</text>
              <text x="140" y="137" text-anchor="middle" font-size="14" fill="white">ğŸ’»</text>
            </svg>
          </div>
          <h2>Sincroniza en la Nube</h2>
          <p>Crea un cÃ³digo de respaldo para sincronizar tus datos entre dispositivos. Â¡Nunca pierdas tu informaciÃ³n!
          </p>
        </div>

        <!-- Slide 6: EstadÃ­sticas -->
        <div class="onboarding-slide">
          <div class="onboarding-image">
            <svg width="200" height="160" viewBox="0 0 200 160" fill="none">
              <rect x="40" y="100" width="30" height="40" rx="4" fill="#10b981" />
              <rect x="80" y="70" width="30" height="70" rx="4" fill="#3b82f6" />
              <rect x="120" y="50" width="30" height="90" rx="4" fill="#8b5cf6" />
              <line x1="30" y1="145" x2="170" y2="145" stroke="#64748b" stroke-width="2" />
              <line x1="30" y1="145" x2="30" y2="40" stroke="#64748b" stroke-width="2" />
              <text x="100" y="30" text-anchor="middle" font-size="24" fill="#6366f1">ğŸ“Š</text>
            </svg>
          </div>
          <h2>Dashboard y EstadÃ­sticas</h2>
          <p>Visualiza tu progreso con grÃ¡ficos, estadÃ­sticas y un ranking de tus asignaturas. Exporta informes en PDF
            cuando lo necesites.</p>
        </div>

        <!-- Slide 7: Liquid Glass -->
        <div class="onboarding-slide">
          <div class="onboarding-image lens-glare">
            <svg width="200" height="160" viewBox="0 0 200 160" fill="none">
              <defs>
                <linearGradient id="lg" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#f0f9ff" />
                  <stop offset="50%" stop-color="#93c5fd" />
                  <stop offset="100%" stop-color="#3b82f6" />
                </linearGradient>
              </defs>
              <rect x="20" y="25" width="160" height="110" rx="14" fill="url(#lg)" opacity="0.7" />
              <rect x="28" y="35" width="144" height="92" rx="12" fill="#ffffff" opacity="0.25" />
              <rect x="28" y="35" width="144" height="92" rx="12" stroke="#ffffff" stroke-opacity="0.6" />
              <text x="100" y="88" text-anchor="middle" font-size="20" fill="#0f172a" font-weight="600">Liquid
                Glass</text>
            </svg>
          </div>
          <h2>Modo Liquid Glass</h2>
          <p>Un tema con fondo azul-blanco animado y efecto vidrio. Mejora el contraste en iOS y Android y puedes
            activarlo desde el botÃ³n de modo. Pulsa varias veces para alternar Claro â†’ Oscuro â†’ Glass.</p>
          <div style="margin-top: 16px; display: flex; justify-content: center;">
            <button class="cta cta-primary" onclick="applyTheme('glass')"
              style="box-shadow: 0 4px 12px rgba(59,130,246,0.3); padding: 8px 20px; font-size: 14px;">
              Activar ahora
            </button>
          </div>
        </div>
      </div>

      <div class="onboarding-dots">
        <span class="dot active"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>

      <div class="onboarding-actions">
        <button class="onboarding-btn-secondary" id="prev-slide">â† Anterior</button>
        <button class="onboarding-btn-primary" id="next-slide">Siguiente â†’</button>
        <button class="onboarding-btn-primary" id="finish-onboarding" style="display:none;">Â¡Empezar!</button>
      </div>
    </div>
  </div>

  <!-- Pantalla de menÃº principal -->
  <div id="menu-screen" class="screen active">
    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Alternar modo oscuro"
      title="Modo oscuro">ğŸŒ™</button>
    <button id="show-archived-toggle" class="show-archived-toggle" aria-label="Mostrar archivados"
      title="Mostrar archivados">ğŸ“¦</button>
    <button id="firebase-btn" class="firebase-toggle" aria-label="SincronizaciÃ³n en la nube"
      title="Sincronizar con la nube">â˜ï¸</button>
    <button id="changelog-btn" class="changelog-toggle" aria-label="Historial de cambios"
      title="Historial de cambios">ğŸ“</button>
    <div id="sync-indicator" class="sync-indicator" style="display:none;">
      <span class="sync-spinner"></span>
      <span class="sync-text">Sincronizando...</span>
    </div>

    <!-- Modal para cÃ³digo de sincronizaciÃ³n -->
    <div id="sync-code-modal" class="modal-overlay" style="display:none;">
      <div class="modal" style="max-width: 480px; height: auto; max-height: none;">
        <div class="modal-header"
          style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); position: relative; border-bottom: 1px solid rgba(0,0,0,0.06);">
          <h2 class="modal-title">ğŸ”„ SincronizaciÃ³n en la Nube</h2>
          <div class="app-version" id="version-badge" style="cursor: pointer; user-select: none;"
            title="Ver historial de cambios">v2.3.22</div>
        </div>
        <div class="modal-body">
          <div id="sync-code-content"></div>
        </div>
      </div>
    </div>

    <!-- Modal de Changelog -->
    <div id="changelog-modal" class="modal-overlay" style="display:none;">
      <div class="modal" style="max-width: 700px; height: 80vh;">
        <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">
          <h2 class="modal-title">ğŸ“‹ Historial de Cambios</h2>
          <button class="close-modal-btn" id="close-changelog" aria-label="Cerrar">âœ•</button>
        </div>
        <div class="modal-body" style="overflow-y: auto; padding: 24px;">
          <div style="margin-bottom: 20px;">
            <button id="show-tutorial-btn" class="tutorial-launcher-btn">
              âœ¨ Ver Tutorial de Funcionalidades
            </button>
            <div style="margin-top: 10px;">
              <button id="test-ios-btn" class="tutorial-launcher-btn" title="Probar sugerencia Liquid Glass en iOS">
                ğŸ Test iOS: Prueba Liquid Glass
              </button>
            </div>
          </div>
          <div id="changelog-content" style="color: #1e293b;">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
              <div class="changelog-loader"></div>
              <p>Cargando historial de cambios...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Cuatrimestres Archivados -->
    <div id="archived-modal" class="modal-overlay" style="display:none;">
      <div class="modal" style="max-width: 900px; height: 85vh;">
        <div class="modal-header" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);">
          <h2 class="modal-title">ğŸ“¦ Cuatrimestres Archivados</h2>
          <button class="close-modal-btn" id="close-archived" aria-label="Cerrar">âœ•</button>
        </div>
        <div class="modal-body" style="overflow-y: auto; padding: 24px;">
          <div id="archived-semesters-container" class="semesters-grid"></div>
        </div>
      </div>
    </div>

    <header>
      <h1>ğŸ“š Mis Cursos</h1>
      <p class="hint">Selecciona un cuatrimestre para gestionar tus asignaturas.</p>
    </header>
    <div id="upcoming-exams-alert" class="upcoming-exams-alert" style="display:none;"></div>
    <div class="search-container">
      <input type="text" id="global-search-input" placeholder="ğŸ” Buscar en todos los cuatrimestres..."
        aria-label="Buscar cuatrimestre o asignatura">
    </div>
    <main>
      <div id="semesters-container" class="semesters-grid" aria-label="Lista de cuatrimestres">
        <!-- El botÃ³n de aÃ±adir cuatrimestre se inyectarÃ¡ dinÃ¡micamente aquÃ­ dentro -->
      </div>
    </main>
    <!-- BotÃ³n FAB antiguo eliminado: <button id="add-semester-btn" ... -->
  </div>

  <!-- Pantalla de gestiÃ³n de asignaturas -->
  <div id="subjects-screen" class="screen">
    <button id="back-btn" class="btn-back" aria-label="Volver al menÃº">Volver</button>

    <!-- MenÃº de herramientas (FAB) -->
    <div class="tools-menu-wrapper">
      <button id="tools-menu-toggle" class="fab-main" aria-label="Abrir menÃº de herramientas">
        <span class="fab-icon">âœ¨</span>
      </button>
      <div class="fab-menu" id="tools-menu">
        <button id="toggle-all-progress-btn" class="fab-option" data-tooltip="Progreso"
          aria-label="Mostrar/ocultar progresos">
          <span>ğŸ“Š</span>
        </button>
        <button id="calculator-btn" class="fab-option" data-tooltip="Calculadora" aria-label="Calculadora de notas">
          <span>ğŸ§®</span>
        </button>
        <button id="dashboard-btn" class="fab-option" data-tooltip="Dashboard" aria-label="Ver estadÃ­sticas">
          <span>ğŸ“ˆ</span>
        </button>
        <button id="export-pdf-btn" class="fab-option" data-tooltip="Exportar PDF" aria-label="Exportar informe PDF">
          <span>ğŸ“„</span>
        </button>
        <button id="exams-btn" class="fab-option" data-tooltip="ExÃ¡menes" aria-label="Gestionar exÃ¡menes">
          <span>ğŸ“…</span>
        </button>
      </div>
    </div>

    <div id="desktop-placeholder" class="desktop-placeholder" style="display:none;">
      <div class="placeholder-content">
        <span style="font-size: 48px;">ğŸ‘ˆ</span>
        <h2>Selecciona un cuatrimestre</h2>
        <p>Elige un curso del menÃº lateral para ver sus asignaturas o crea uno nuevo.</p>
      </div>
    </div>

    <div id="subjects-content-wrapper">
      <header>
        <h1 id="subjects-title">Asignaturas</h1>
        <div id="ai-recommendation" class="ai-recommendation" style="display:none;">
          <span id="ai-recommendation-text"></span>
        </div>
      </header>
      <div class="subjects-stats" id="subjects-stats" style="display:none;">
        <div class="stat-item">
          <span class="stat-label">Media:</span>
          <span class="stat-value" id="stat-average">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">ECTS:</span>
          <span class="stat-value" id="stat-ects">0</span>
        </div>
      </div>
      <main>
        <div id="container" aria-label="Lista de asignaturas"></div>
      </main>
    </div>
    <button id="add-btn" aria-label="AÃ±adir asignatura" class="fab-btn">+</button>
  </div>

  <!-- Modal Calculadora de Notas -->
  <div id="calculator-modal" class="modal-overlay" style="display:none;">
    <div class="modal calculator-modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">
        <h2 class="modal-title">ğŸ§® Â¿QuÃ© nota necesito?</h2>
        <button class="close-modal-btn" onclick="closeCalculatorModal()" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="calculator-content">
          <div class="calc-input-group">
            <label for="calc-current-grade">Nota actual acumulada:</label>
            <input type="number" id="calc-current-grade" min="0" max="10" step="0.1" placeholder="0.0" />
          </div>
          <div class="calc-input-group">
            <label for="calc-percentage-done">% del curso completado:</label>
            <input type="number" id="calc-percentage-done" min="0" max="100" step="1" placeholder="0" />
          </div>
          <div class="calc-input-group">
            <label for="calc-target-grade">Nota objetivo:</label>
            <input type="number" id="calc-target-grade" min="0" max="10" step="0.1" value="5.0" placeholder="5.0" />
          </div>
          <button class="calc-btn-primary" onclick="calculateNeededGrade()">Calcular</button>
          <div id="calc-result" class="calc-result" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Export PDF -->
  <div id="export-modal" class="modal-overlay" style="display:none;">
    <div class="modal export-modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);">
        <h2 class="modal-title">ğŸ“„ Exportar Informe PDF</h2>
        <button class="close-modal-btn" onclick="closeExportModal()" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="export-content">
          <div class="export-options">
            <h3 style="margin-top: 0;">Opciones de ExportaciÃ³n</h3>

            <label class="export-checkbox">
              <input type="checkbox" id="export-cover" checked>
              <span>Portada con tÃ­tulo y fecha</span>
            </label>

            <label class="export-checkbox">
              <input type="checkbox" id="export-stats" checked>
              <span>EstadÃ­sticas generales</span>
            </label>

            <label class="export-checkbox">
              <input type="checkbox" id="export-charts" checked>
              <span>GrÃ¡ficos y visualizaciones</span>
            </label>

            <label class="export-checkbox">
              <input type="checkbox" id="export-subjects" checked>
              <span>Detalle por asignatura</span>
            </label>

            <label class="export-checkbox">
              <input type="checkbox" id="export-recommendations" checked>
              <span>Recomendaciones IA</span>
            </label>

            <div class="export-title-input">
              <label for="export-title-text">TÃ­tulo del informe:</label>
              <input type="text" id="export-title-text" value="" placeholder="Ej: Informe AcadÃ©mico Q1 2025">
            </div>
          </div>

          <button class="export-btn-primary" onclick="generatePDF()">
            <span style="font-size: 20px; margin-right: 8px;">ğŸ“„</span>
            Generar PDF
          </button>

          <div id="export-progress" class="export-progress" style="display: none;">
            <div class="progress-spinner"></div>
            <span>Generando PDF...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal ExÃ¡menes -->
  <div id="exams-modal" class="modal-overlay" style="display:none;">
    <div class="modal exams-modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <h2 class="modal-title">ğŸ“… ExÃ¡menes Futuros</h2>
        <button class="close-modal-btn" onclick="closeExamsModal()" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="exams-wrapper">
          <div class="exams-actions-container">
            <button class="btn-add-exam" onclick="openAddExamForm()">â• AÃ±adir Examen</button>
            <button class="btn-export-exam" onclick="generateAndDownloadICS()">ğŸ“… Exportar</button>
          </div>

          <div id="add-exam-form" class="add-exam-form" style="display:none;">
            <h3>Nuevo Examen</h3>
            <div class="exam-form-group">
              <label for="exam-subject-select">Asignatura:</label>
              <select id="exam-subject-select" class="exam-select">
                <option value="">Selecciona una asignatura...</option>
              </select>
            </div>
            <div class="exam-form-group">
              <label for="exam-date-input">Fecha del examen:</label>
              <input type="date" id="exam-date-input" class="exam-input" />
            </div>
            <div class="exam-form-group">
              <label for="exam-time-input">Hora (opcional):</label>
              <input type="time" id="exam-time-input" class="exam-input" />
            </div>
            <div class="exam-form-group">
              <label for="exam-location-input">UbicaciÃ³n (opcional):</label>
              <input type="text" id="exam-location-input" class="exam-input" placeholder="Ej: Aula 203" />
            </div>
            <div class="exam-form-actions">
              <button class="btn btn-ghost" onclick="closeAddExamForm()">Cancelar</button>
              <button class="btn btn-primary" onclick="saveExam()">Guardar</button>
            </div>
          </div>

          <div id="exams-list" class="exams-list">
            <!-- Los exÃ¡menes futuros se renderizarÃ¡n aquÃ­ -->
          </div>

          <div id="past-exams-section"
            style="margin-top: 30px; display:none; border-top: 1px solid var(--input-border); padding-top: 20px;">
            <button id="toggle-past-exams" class="btn btn-ghost" style="width:100%; margin-bottom:15px;">â¬‡ï¸ Ver ExÃ¡menes
              Pasados</button>
            <div id="past-exams-list" class="exams-list" style="display:none; opacity: 0.7;">
              <!-- Los exÃ¡menes pasados se renderizarÃ¡n aquÃ­ -->
            </div>
          </div>

          <div id="no-exams-message" class="no-exams-message" style="display:none;">
            <p>ğŸ“š No hay exÃ¡menes programados</p>
            <p class="hint">AÃ±ade tu primer examen para llevar un seguimiento de tus fechas importantes.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Dashboard -->
  <div id="dashboard-modal" class="modal-overlay" style="display:none;">
    <div class="modal dashboard-modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);">
        <h2 class="modal-title">ğŸ“Š Dashboard</h2>
        <button class="close-modal-btn" onclick="closeDashboardModal()" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="dashboard-content">
          <!-- Tabs -->
          <div class="dashboard-tabs">
            <button class="dashboard-tab active" data-tab="stats">ğŸ“Š EstadÃ­sticas</button>
            <button class="dashboard-tab" data-tab="chart">ğŸ“ˆ GrÃ¡fico</button>
            <button class="dashboard-tab" data-tab="ranking">ğŸ† Ranking</button>
          </div>

          <!-- Tab Content: EstadÃ­sticas -->
          <div class="dashboard-tab-content active" data-content="stats">
            <div class="dashboard-stats-grid">
              <div class="stat-card">
                <span class="stat-card-label">Promedio</span>
                <span class="stat-card-value" id="dash-average">-</span>
              </div>
              <div class="stat-card">
                <span class="stat-card-label">Aprobadas</span>
                <span class="stat-card-value" id="dash-passed">-</span>
              </div>
              <div class="stat-card">
                <span class="stat-card-label">Suspendidas</span>
                <span class="stat-card-value" id="dash-failed">-</span>
              </div>
              <div class="stat-card">
                <span class="stat-card-label">ECTS Totales</span>
                <span class="stat-card-value" id="dash-ects">-</span>
              </div>
            </div>
          </div>

          <!-- Tab Content: GrÃ¡fico -->
          <div class="dashboard-tab-content" data-content="chart">
            <div class="dashboard-chart">
              <h3 class="chart-title">DistribuciÃ³n de Notas</h3>
              <div id="grades-chart-bars" class="chart-bars"></div>
            </div>
          </div>

          <!-- Tab Content: Ranking -->
          <div class="dashboard-tab-content" data-content="ranking">
            <div class="dashboard-list">
              <div id="subjects-ranking"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalles de Examen -->
  <div id="exam-detail-modal" class="modal-overlay" style="display:none;">
    <div class="modal exam-detail-modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
        <h2 class="modal-title">ğŸ“‹ Detalles del Examen</h2>
        <button class="close-modal-btn" onclick="closeExamDetailModal()" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="exam-detail-content" id="exam-detail-content">
          <!-- Los detalles se renderizarÃ¡n aquÃ­ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal sugerencia Liquid Glass para iOS -->
  <div id="glass-suggestion-modal" class="modal-overlay" style="display:none;">
    <div class="modal glass-suggestion-modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);">
        <h2 class="modal-title">ğŸ’§ Modo Liquid Glass</h2>
        <button class="close-modal-btn" onclick="closeGlassSuggestion()" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="glass-suggestion-content">
          <div class="glass-preview strong-glare" aria-hidden="true">
            <div class="preview-card lens-glare-strong">
              <!-- SVG idÃ©ntico al del Ãºltimo slide del tutorial -->
              <svg width="100%" height="auto" viewBox="0 0 200 160" fill="none" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <linearGradient id="lg-suggestion" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#f0f9ff" />
                    <stop offset="50%" stop-color="#93c5fd" />
                    <stop offset="100%" stop-color="#3b82f6" />
                  </linearGradient>
                </defs>
                <rect x="20" y="25" width="160" height="110" rx="14" fill="url(#lg-suggestion)" opacity="0.7" />
                <rect x="28" y="35" width="144" height="92" rx="12" fill="#ffffff" opacity="0.25" />
                <rect x="28" y="35" width="144" height="92" rx="12" stroke="#ffffff" stroke-opacity="0.6" />
                <text x="100" y="88" text-anchor="middle" font-size="20" fill="#0f172a" font-weight="600">Liquid
                  Glass</text>
              </svg>
            </div>
          </div>
          <p class="glass-suggestion-text">
            En iOS, el modo Liquid Glass mejora el contraste con un efecto elegante y suave.
            Â¿Quieres activarlo ahora?
          </p>
          <div class="modal-actions center">
            <button class="cta cta-primary" onclick="activateGlassModeFromSuggestion()">Activar ahora</button>
            <button class="cta cta-secondary" onclick="closeGlassSuggestion()">MÃ¡s tarde</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* -------------------------
       ConfiguraciÃ³n y utilidades
       ------------------------- */
    const container = document.getElementById('container');
    const ADD_BTN = document.getElementById('add-btn');
    const menuScreen = document.getElementById('menu-screen');
    const subjectsScreen = document.getElementById('subjects-screen');
    const backBtn = document.getElementById('back-btn');
    const addSemesterBtn = document.getElementById('add-semester-btn'); // may be null
    const semestersContainer = document.getElementById('semesters-container');
    const subjectsTitle = document.getElementById('subjects-title');
    const toggleAllProgressBtn = document.getElementById('toggle-all-progress-btn');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const showArchivedToggle = document.getElementById('show-archived-toggle');

    let currentSemester = null; // Semestre actualmente seleccionado

    // Sistema de historial para deshacer (Ctrl+Z)
    const undoHistory = [];
    const MAX_HISTORY_SIZE = 50;
    let isUndoing = false;

    // FunciÃ³n auxiliar para parsear nÃºmeros con coma, coma alta o punto como decimal
    function parseNumber(value) {
      if (typeof value === 'number') return value;
      if (!value) return 0;

      // Convertir a string y normalizar
      let str = String(value).trim();

      // Reemplazar comas altas (') y comas (,) por punto (.)
      str = str.replace(/[',]/g, '.');

      // Parsear el nÃºmero
      const num = parseFloat(str);
      return isNaN(num) ? 0 : num;
    }

    function saveStateToHistory(actionType = 'cambio') {
      if (isUndoing) return; // No guardar durante un undo

      const state = {
        cuatrimestres: JSON.parse(JSON.stringify(obtenerCuatrimestres())),
        exams: JSON.parse(localStorage.getItem('exams') || '[]'),
        timestamp: Date.now(),
        action: actionType
      };

      undoHistory.push(state);

      // Limitar tamaÃ±o del historial
      if (undoHistory.length > MAX_HISTORY_SIZE) {
        undoHistory.shift();
      }
    }

    function undo() {
      if (undoHistory.length === 0) {
        showSyncIndicator('No hay cambios para deshacer', 'error');
        return;
      }

      isUndoing = true;

      // Obtener el estado anterior (el Ãºltimo guardado)
      const previousState = undoHistory.pop();

      // Restaurar el estado
      localStorage.setItem('cuatrimestres', JSON.stringify(previousState.cuatrimestres));
      localStorage.setItem('exams', JSON.stringify(previousState.exams));

      // Actualizar la interfaz
      if (menuScreen.classList.contains('active')) {
        renderSemesters();
        checkUpcomingExams();
      } else if (currentSemester) {
        // Actualizar el semestre actual despuÃ©s de deshacer
        const cuatrimestres = obtenerCuatrimestres();
        const updatedSemester = cuatrimestres.find(c => c.id === currentSemester.id);
        if (updatedSemester) {
          currentSemester = updatedSemester;
          renderSubjects();
        } else {
          showMenuScreen();
        }
      }

      // Sincronizar con Firebase
      scheduleSyncToFirebase();

      showSyncIndicator(`Cambio deshecho: ${previousState.action}`, 'success');

      setTimeout(() => {
        isUndoing = false;
      }, 100);
    }

    // Atajo de teclado Ctrl+Z
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      }
    });

    const COLOR_OPTIONS = [
      { value: '#ff4d4d', label: 'Rojo' },
      { value: '#ff954d', label: 'Naranja' },
      { value: '#ffe14d', label: 'Amarillo' },
      { value: '#9cff4d', label: 'Verde claro' },
      { value: '#2e8b57', label: 'Verde oscuro' }
    ];

    /* -------------------------
       GestiÃ³n de pantallas
       ------------------------- */
    function showMenuScreen() {
      // Logic for mobile vs desktop
      const isDesktop = window.innerWidth >= 1024;

      if (document.startViewTransition) {
        document.startViewTransition(() => {
          menuScreen.classList.add('active');
          if (!isDesktop) {
            subjectsScreen.classList.remove('active');
          }
          // On desktop, we don't clear currentSemester immediately if we want persistence, 
          // BUT the requirement is "on first open, subject column is empty".
          // If the user explicitly clicks "Back", maybe we should clear selection on desktop too?
          // Let's clear selection to show the placeholder.
          currentSemester = null;
          renderSemesters();
          checkUpcomingExams();
          updateDesktopPlaceholder();

          // Always center on desktop when showing menu (unselected state)
          if (window.innerWidth >= 1024) {
            document.body.classList.add('center-mode');
          }
        });
      } else {
        menuScreen.classList.add('active');
        if (!isDesktop) {
          subjectsScreen.classList.remove('active');
        }
        currentSemester = null;
        renderSemesters();
        checkUpcomingExams();
        updateDesktopPlaceholder();

        // Always center on desktop when showing menu (unselected state)
        if (window.innerWidth >= 1024) {
          document.body.classList.add('center-mode');
        }
      }
    }

    function showSubjectsScreen(semester) {
      currentSemester = semester;
      subjectsTitle.textContent = semester.nombre;

      const isDesktop = window.innerWidth >= 1024;

      if (document.startViewTransition) {
        document.startViewTransition(() => {
          if (!isDesktop) {
            menuScreen.classList.remove('active');
          }
          subjectsScreen.classList.add('active');
          renderSubjects();
          updateAIRecommendation();
          updateDesktopPlaceholder();

          if (isDesktop) {
            document.body.classList.remove('center-mode');
          }
        });
      } else {
        if (isDesktop) {
          menuScreen.classList.add('active');
          subjectsScreen.classList.add('active');
          document.body.classList.remove('center-mode');
        } else {
          menuScreen.classList.remove('active');
          subjectsScreen.classList.add('active');
        }
        renderSubjects();
        updateAIRecommendation();
        updateDesktopPlaceholder();
      }
    }

    function updateDesktopPlaceholder() {
      const placeholder = document.getElementById('desktop-placeholder');
      const subjectsContent = document.getElementById('subjects-content-wrapper'); // We will wrap subject content

      if (!placeholder || !subjectsContent) return; // Si no existen (mÃ³vil o estructura antigua)

      if (!currentSemester) {
        placeholder.style.display = 'flex';
        subjectsContent.style.display = 'none';
        document.getElementById('add-btn').style.display = 'none'; // Hide FAB
        document.querySelector('.tools-menu-wrapper').style.display = 'none'; // Hide tools
      } else {
        placeholder.style.display = 'none';
        subjectsContent.style.display = 'block';
        document.getElementById('add-btn').style.display = 'flex'; // Show FAB
        document.querySelector('.tools-menu-wrapper').style.display = 'block'; // Show tools
      }
    }

    backBtn.addEventListener('click', showMenuScreen);

    // Soporte para gestos nativos de Android/iOS (botÃ³n atrÃ¡s del navegador)
    window.addEventListener('popstate', (event) => {
      // Si el modal de exÃ¡menes estÃ¡ abierto, cerrarlo
      if (examsModal && examsModal.classList.contains('show')) {
        closeExamsModal();
        return;
      }

      if (subjectsScreen.classList.contains('active')) {
        event.preventDefault();
        showMenuScreen();
      }
    });

    // Agregar entrada al historial cuando se navega a asignaturas
    const originalShowSubjectsScreen = showSubjectsScreen;
    showSubjectsScreen = function (semester) {
      originalShowSubjectsScreen(semester);
      // AÃ±adir estado al historial para permitir volver con gesto
      if (!window.location.hash || window.location.hash !== '#subjects') {
        history.pushState({ screen: 'subjects', semester: semester.id }, '', '#subjects');
      }
    };

    // Inicializar: si estÃ¡ en menu, limpiar hash
    if (menuScreen.classList.contains('active')) {
      history.replaceState({ screen: 'menu' }, '', '#menu');
    }

    // BÃºsqueda global en menÃº principal
    const globalSearchInput = document.getElementById('global-search-input');
    globalSearchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      const semesterCards = document.querySelectorAll('.semester-card');

      if (query === '') {
        // Mostrar todos los cuatrimestres
        semesterCards.forEach(card => {
          card.style.display = 'block';
          // Eliminar tarjetas de asignaturas si existen
          const subjectResults = card.querySelector('.subject-search-results');
          if (subjectResults) subjectResults.remove();
        });
        return;
      }

      const cuatrimestres = obtenerCuatrimestres();

      semesterCards.forEach(card => {
        const semesterName = card.querySelector('h3').textContent.toLowerCase();
        const semesterId = parseInt(card.querySelector('.btn-edit-semester').dataset.id);
        const semester = cuatrimestres.find(c => c.id === semesterId);

        // Eliminar resultados anteriores
        const oldResults = card.querySelector('.subject-search-results');
        if (oldResults) oldResults.remove();

        // Buscar en nombre del cuatrimestre
        if (semesterName.includes(query)) {
          card.style.display = 'block';
          return;
        }

        // Buscar en asignaturas del cuatrimestre
        if (semester && semester.asignaturas) {
          const matchingSubjects = semester.asignaturas.filter(a =>
            a.nombre.toLowerCase().includes(query)
          );

          if (matchingSubjects.length > 0) {
            card.style.display = 'block';

            // Crear contenedor de resultados
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'subject-search-results';

            matchingSubjects.forEach(subject => {
              const subjectCard = document.createElement('div');
              subjectCard.className = 'subject-result-card';
              subjectCard.style.background = subject.color || '#ff4d4d';
              subjectCard.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <span style="font-weight: 500; color: #06243b;">${escapeHtml(subject.nombre)}</span>
              <button class="view-subject-btn" data-semester-id="${semesterId}" data-subject-name="${escapeHtml(subject.nombre)}" style="background: rgba(255,255,255,0.3); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #06243b;">
                Ver â†’
              </button>
            </div>
          `;

              // Event listener para ir a la asignatura
              subjectCard.querySelector('.view-subject-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showSubjectsScreen(semester);
                // Esperar a que se rendericen las tarjetas y abrir modal de pruebas
                setTimeout(() => {
                  const cards = document.querySelectorAll('.card:not(.drag-preview)');
                  cards.forEach(c => {
                    if (c.querySelector('.titulo').textContent === subject.nombre) {
                      c.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      // Abrir directamente el modal de pruebas evaluables
                      setTimeout(() => {
                        openSubjectDetail(c);
                      }, 150);
                    }
                  });
                }, 100);
              });

              resultsContainer.appendChild(subjectCard);
            });

            // Insertar despuÃ©s de la info del semestre
            const semesterInfo = card.querySelector('.semester-info');
            semesterInfo.insertAdjacentElement('afterend', resultsContainer);
          } else {
            card.style.display = 'none';
          }
        } else {
          card.style.display = 'none';
        }
      });
    });

    // Toggle todos los progresos
    toggleAllProgressBtn.addEventListener('click', () => {
      const allCards = document.querySelectorAll('.card:not(.drag-preview)');
      if (allCards.length === 0) return;

      // Verificar si alguno estÃ¡ visible (usando la clase .open)
      const firstWrapper = allCards[0].querySelector('.progress-wrapper');
      const isAnyOpen = firstWrapper && firstWrapper.classList.contains('open');

      allCards.forEach(card => {
        const p = card.querySelector('.progress-wrapper');
        if (p) {
          if (isAnyOpen) {
            p.classList.remove('open');
          } else {
            p.classList.add('open');
            updateSubjectProgress(card);
          }
        }
      });

      // Actualizar texto del botÃ³n
      toggleAllProgressBtn.textContent = 'ğŸ“Š';
    });

    // Modo de visualizaciÃ³n (claro, oscuro, glass)
    function initThemeMode() {
      const theme = localStorage.getItem('themeMode') || 'light';
      applyTheme(theme);
    }

    function applyTheme(theme) {
      document.body.classList.remove('dark-mode', 'glass-mode');

      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        darkModeToggle.textContent = 'ğŸ’§';
      } else if (theme === 'glass') {
        document.body.classList.add('glass-mode');
        darkModeToggle.textContent = 'â˜€ï¸';
      } else {
        darkModeToggle.textContent = 'ğŸŒ™';
      }

      localStorage.setItem('themeMode', theme);
    }

    darkModeToggle.addEventListener('click', () => {
      const currentTheme = localStorage.getItem('themeMode') || 'light';
      let nextTheme;

      if (currentTheme === 'light') {
        nextTheme = 'dark';
      } else if (currentTheme === 'dark') {
        nextTheme = 'glass';
      } else {
        nextTheme = 'light';
      }

      applyTheme(nextTheme);
    });

    // DetecciÃ³n de iOS
    function isIOS() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isIpadIphoneIpod = /iPad|iPhone|iPod/.test(ua);
      const isTouchMac = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      return isIpadIphoneIpod || isTouchMac;
    }

    // DetecciÃ³n de Android
    function isAndroid() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      return /Android/i.test(ua);
    }

    // Sugerencia de Liquid Glass
    function openGlassSuggestion() {
      const modal = document.getElementById('glass-suggestion-modal');
      if (!modal) return;
      modal.style.display = 'flex';
      requestAnimationFrame(() => modal.classList.add('show'));
    }
    function closeGlassSuggestion() {
      const modal = document.getElementById('glass-suggestion-modal');
      if (!modal) return;
      modal.classList.remove('show');
      setTimeout(() => { modal.style.display = 'none'; }, 250);
    }
    function activateGlassModeFromSuggestion() {
      applyTheme('glass');
      closeGlassSuggestion();
    }

    // Mostrar/ocultar archivados
    showArchivedToggle.addEventListener('click', () => {
      openArchivedModal();
    });

    // Funciones para modal de archivados
    function openArchivedModal() {
      const modal = document.getElementById('archived-modal');
      const container = document.getElementById('archived-semesters-container');

      // Renderizar solo cuatrimestres archivados
      container.innerHTML = '';
      const cuatrimestres = obtenerCuatrimestres();
      const archived = cuatrimestres.filter(sem => sem.archived);

      if (archived.length === 0) {
        container.innerHTML = '<div class="empty-state">No hay cuatrimestres archivados</div>';
      } else {
        archived.forEach(sem => {
          const card = document.createElement('div');
          card.className = 'semester-card archived';
          card.dataset.semesterId = sem.id;
          const numAsignaturas = sem.asignaturas ? sem.asignaturas.length : 0;
          card.innerHTML = `
        <h3>${escapeHtml(sem.nombre)}</h3>
        <p class="semester-info">${numAsignaturas} asignatura${numAsignaturas !== 1 ? 's' : ''}</p>
        <div class="semester-actions">
          <div class="semester-actions-top">
            <button class="btn-duplicate-semester" data-id="${sem.id}" aria-label="Duplicar" title="Duplicar">ğŸ“‹ Duplicar</button>
            <button class="btn-archive-semester" data-id="${sem.id}" aria-label="Desarchivar" title="Desarchivar">ğŸ“‚ Desarchivar</button>
          </div>
          <div class="semester-actions-bottom">
            <button class="btn-edit-semester" data-id="${sem.id}" aria-label="Editar nombre">Editar</button>
            <button class="btn-delete-semester" data-id="${sem.id}" aria-label="Eliminar">Eliminar</button>
          </div>
        </div>
      `;

          // Click para abrir
          card.addEventListener('click', (e) => {
            if (!e.target.closest('.semester-actions')) {
              closeArchivedModal();
              setTimeout(() => showSubjectsScreen(sem), 300);
            }
          });

          // Duplicar
          card.querySelector('.btn-duplicate-semester').addEventListener('click', (e) => {
            e.stopPropagation();
            openDuplicateSheet(sem);
          });

          // Desarchivar
          card.querySelector('.btn-archive-semester').addEventListener('click', (e) => {
            e.stopPropagation();
            saveStateToHistory('desarchivar cuatrimestre');
            const cuatrimestres = obtenerCuatrimestres();
            const idx = cuatrimestres.findIndex(c => c.id === sem.id);
            if (idx !== -1) {
              cuatrimestres[idx].archived = false;
              localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
              openArchivedModal(); // Refrescar modal
              scheduleSyncToFirebase();
            }
          });

          // Editar nombre
          card.querySelector('.btn-edit-semester').addEventListener('click', (e) => {
            e.stopPropagation();
            openEditSheet(sem);
          });

          // Eliminar
          card.querySelector('.btn-delete-semester').addEventListener('click', (e) => {
            e.stopPropagation();
            openDeleteSheet(sem);
          });

          container.appendChild(card);
        });
      }

      modal.style.display = 'flex';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeArchivedModal() {
      const modal = document.getElementById('archived-modal');
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
        // Recargar vista principal por si hubo cambios
        renderSemesters();
      }, 250);
    }

    document.getElementById('close-archived').addEventListener('click', closeArchivedModal);

    /* -------------------------
       GestiÃ³n de cuatrimestres
       ------------------------- */
    function guardarCuatrimestres() {
      const datos = JSON.parse(localStorage.getItem('cuatrimestres')) || [];
      localStorage.setItem('cuatrimestres', JSON.stringify(datos));
    }



    function obtenerCuatrimestres() {
      return JSON.parse(localStorage.getItem('cuatrimestres')) || [];
    }

    function renderSemesters() {
      try {
        semestersContainer.innerHTML = '';
        let cuatrimestres = obtenerCuatrimestres();

        if (cuatrimestres.length === 0) {
          // Verificar si hay datos antiguos (asignaturas) SOLO en primera carga
          const datosAntiguos = JSON.parse(localStorage.getItem('asignaturas')) || [];

          if (datosAntiguos.length > 0) {
            // Solo migrar si hay datos antiguos
            cuatrimestres = [
              {
                id: Date.now(),
                nombre: 'Curso 2025/26 - Cuatrimestre 1',
                asignaturas: datosAntiguos,
                archived: false
              },
              {
                id: Date.now() + 1,
                nombre: 'Curso 2025/26 - Cuatrimestre 2',
                asignaturas: [],
                archived: false
              }
            ];
            localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
            // Limpiar datos antiguos
            localStorage.removeItem('asignaturas');
          } else {
            // No hay cuatrimestres ni datos antiguos - mostrar mensaje
            semestersContainer.innerHTML = '<div class="empty-state">No hay cursos que mostrar</div>';
            return;
          }
        }

        // Mostrar solo cuatrimestres NO archivados
        const filteredSemesters = cuatrimestres.filter(sem => !sem.archived);

        if (filteredSemesters.length === 0) {
          semestersContainer.innerHTML = '';
          // 1. Case Empty: Add button alone
          const addBtn = createAddSemesterCard();
          semestersContainer.appendChild(addBtn);
          return;
        }

        semestersContainer.innerHTML = ''; // Clear container

        // 2. Case with items: Render items first
        filteredSemesters.forEach(sem => {
          // ... (creation of card logic)
          const card = document.createElement('div');
          card.className = 'semester-card' + (sem.archived ? ' archived' : '');
          card.draggable = true;
          card.dataset.semesterId = sem.id;
          const numAsignaturas = sem.asignaturas ? sem.asignaturas.length : 0;
          card.innerHTML = `
      <h3>${escapeHtml(sem.nombre)}</h3>
      <p class="semester-info">${numAsignaturas} asignatura${numAsignaturas !== 1 ? 's' : ''}</p>
      <div class="semester-actions">
        <div class="semester-actions-top">
          <button class="btn-duplicate-semester" data-id="${sem.id}" aria-label="Duplicar" title="Duplicar">ğŸ“‹ Duplicar</button>
          <button class="btn-archive-semester" data-id="${sem.id}" aria-label="${sem.archived ? 'Desarchivar' : 'Archivar'}" title="${sem.archived ? 'Desarchivar' : 'Archivar'}">${sem.archived ? 'ğŸ“‚' : 'ğŸ“¦'} ${sem.archived ? 'Desarchivar' : 'Archivar'}</button>
        </div>
        <div class="semester-actions-bottom">
          <button class="btn-edit-semester" data-id="${sem.id}" aria-label="Editar nombre">Editar</button>
          <button class="btn-delete-semester" data-id="${sem.id}" aria-label="Eliminar">Eliminar</button>
        </div>
      </div>
    `;

          // Click para abrir
          card.addEventListener('click', (e) => {
            if (!e.target.closest('.semester-actions')) {
              showSubjectsScreen(sem);
            }
          });

          // Drag & Drop para reordenar
          card.addEventListener('dragstart', (e) => {
            card.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
          });

          card.addEventListener('dragend', (e) => {
            card.classList.remove('dragging');
            saveSemestersOrder();
          });

          // Touch para mÃ³viles
          let touchStartY = 0;
          let touchStartX = 0;
          let isTouching = false;
          let longPressTimer = null;
          let isDragEnabled = false;

          card.addEventListener('touchstart', (e) => {
            if (e.target.closest('.semester-actions')) return;
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            isTouching = false;
            isDragEnabled = false;

            // Activar arrastre despuÃ©s de 500ms
            longPressTimer = setTimeout(() => {
              isDragEnabled = true;
              card.style.opacity = '0.8';
              // VibraciÃ³n hÃ¡ptica si estÃ¡ disponible
              if (navigator.vibrate) {
                navigator.vibrate(50);
              }
            }, 500);
          }, { passive: true });

          card.addEventListener('touchmove', (e) => {
            if (e.target.closest('.semester-actions')) return;

            const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
            const deltaX = Math.abs(e.touches[0].clientX - touchStartX);

            // Si se mueve mucho antes de activar el drag, cancelar el timer
            if (!isDragEnabled && (deltaY > 10 || deltaX > 10)) {
              clearTimeout(longPressTimer);
              return;
            }

            // Solo arrastrar si estÃ¡ habilitado
            if (isDragEnabled && (deltaY > 10 || deltaX > 10)) {
              isTouching = true;
              e.preventDefault();
              card.classList.add('dragging');

              const touch = e.touches[0];
              const cards = [...semestersContainer.querySelectorAll('.semester-card:not(.dragging)')];
              const afterElement = cards.find(c => {
                const box = c.getBoundingClientRect();
                return touch.clientY < box.top + box.height / 2;
              });

              semestersContainer.insertBefore(card, afterElement || null);
            }
          }, { passive: false });

          card.addEventListener('touchend', (e) => {
            clearTimeout(longPressTimer);
            card.style.opacity = '';

            if (isTouching) {
              e.preventDefault();
              card.classList.remove('dragging');
              saveSemestersOrder();
            }

            isDragEnabled = false;
            isTouching = false;
          }, { passive: false });

          card.addEventListener('touchcancel', () => {
            clearTimeout(longPressTimer);
            card.style.opacity = '';
            card.classList.remove('dragging');
            isDragEnabled = false;
            isTouching = false;
          });

          // Duplicar
          card.querySelector('.btn-duplicate-semester').addEventListener('click', (e) => {
            e.stopPropagation();
            openDuplicateSheet(sem);
          });

          // Archivar/Desarchivar
          card.querySelector('.btn-archive-semester').addEventListener('click', (e) => {
            e.stopPropagation();
            saveStateToHistory('archivar/desarchivar cuatrimestre');
            const cuatrimestres = obtenerCuatrimestres();
            const idx = cuatrimestres.findIndex(c => c.id === sem.id);
            if (idx !== -1) {
              cuatrimestres[idx].archived = !cuatrimestres[idx].archived;
              localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
              renderSemesters();
            }
          });

          // Editar nombre
          card.querySelector('.btn-edit-semester').addEventListener('click', (e) => {
            e.stopPropagation();
            openEditSheet(sem);
          });

          // Eliminar (abrir bottom-sheet de confirmaciÃ³n)
          card.querySelector('.btn-delete-semester').addEventListener('click', (e) => {
            e.stopPropagation();
            openDeleteSheet(sem);
          });

          semestersContainer.appendChild(card);
        });

        // 3. Add button AT THE END
        const addBtn = createAddSemesterCard();
        semestersContainer.appendChild(addBtn);

        // Verificar y mostrar avisos de exÃ¡menes prÃ³ximos
        checkUpcomingExams();
      } catch (e) {
        console.error("Error rendering semesters:", e);
        semestersContainer.innerHTML = `<div class="error-state">Error cargando datos: ${e.message}</div>`;
      }
    }

    // Guardar orden de cuatrimestres
    function saveSemestersOrder() {
      const cards = semestersContainer.querySelectorAll('.semester-card');
      const cuatrimestres = obtenerCuatrimestres();
      const newOrder = [];

      cards.forEach(card => {
        const id = parseInt(card.dataset.semesterId);
        const semester = cuatrimestres.find(c => c.id === id);
        if (semester) newOrder.push(semester);
      });

      localStorage.setItem('cuatrimestres', JSON.stringify(newOrder));
    }

    // Dragover container
    semestersContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      const afterElement = getDragAfterElement(semestersContainer, e.clientY);
      const draggable = document.querySelector('.dragging');
      if (!draggable) return;
      if (afterElement == null) {
        semestersContainer.appendChild(draggable);
      } else {
        semestersContainer.insertBefore(draggable, afterElement);
      }
    });

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.semester-card:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Helper to create the "Add Semester" card
    function createAddSemesterCard() {
      const btn = document.createElement('div');
      btn.className = 'semester-card add-semester-card';
      btn.innerHTML = `
            <div style="font-size: 32px; margin-bottom: 8px;">â•</div>
            <h3 style="margin-bottom: 4px;">Nuevo Cuatrimestre</h3>
            <p style="font-size: 13px; opacity: 0.7;">Crear curso vacÃ­o</p>
        `;

      btn.style.display = 'flex';
      btn.style.flexDirection = 'column';
      btn.style.alignItems = 'center';
      btn.style.justifyContent = 'center';
      btn.style.border = '2px dashed #cbd5e1';
      btn.style.background = 'transparent';
      btn.style.boxShadow = 'none';
      btn.style.cursor = 'pointer';
      btn.style.opacity = '0.7';
      btn.style.transition = 'all 0.2s ease';

      btn.onclick = () => openCreateSheet(); // Use lambda to ensure correct scope call

      btn.addEventListener('mouseenter', () => {
        btn.style.background = 'rgba(99, 102, 241, 0.05)';
        btn.style.borderColor = '#6366f1';
        btn.style.opacity = '1';
        btn.style.transform = 'translateY(-2px)';
      });

      btn.addEventListener('mouseleave', () => {
        btn.style.background = 'transparent';
        btn.style.borderColor = '#cbd5e1';
        btn.style.opacity = '0.7';
        btn.style.transform = 'translateY(0)';
      });

      return btn;
    }

    function editSemesterName(sem) {
      // (Mantener por compatibilidad; ahora abrimos un bottom-sheet desde el UI.)
      openEditSheet(sem);
    }

    function deleteSemester(semesterId) {
      // EliminaciÃ³n efectiva (la confirmaciÃ³n previa se realiza mediante el bottom-sheet).
      let cuatrimestres = obtenerCuatrimestres();
      cuatrimestres = cuatrimestres.filter(c => c.id !== semesterId);
      localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
      renderSemesters();
    }

    // addSemesterBtn listener functionality depends on the button existing
    if (addSemesterBtn) {
      addSemesterBtn.addEventListener('click', () => {
        openCreateSheet();
      });
    }

    /* -------------------------
       GestiÃ³n de asignaturas
       ------------------------- */
    function guardar() {
      if (!currentSemester) return;
      const cuatrimestres = obtenerCuatrimestres();
      const idx = cuatrimestres.findIndex(c => c.id === currentSemester.id);
      if (idx !== -1) {
        const datos = [];
        // Filtrar tarjetas que no sean drag-preview para evitar duplicados
        document.querySelectorAll('.card:not(.drag-preview)').forEach(c => {
          datos.push({
            nombre: c.querySelector('.titulo').textContent,
            color: c.dataset.color,
            tests: Array.isArray(c._tests) ? c._tests : []
          });
        });
        cuatrimestres[idx].asignaturas = datos;
        currentSemester.asignaturas = datos;
        localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
        actualizarNotasCards();
        actualizarEstadisticas();
      }
    }

    function renderSubjects() {
      container.innerHTML = '';
      if (!currentSemester || !currentSemester.asignaturas) {
        currentSemester.asignaturas = [];
        return;
      }
      currentSemester.asignaturas.forEach(a => {
        const c = crearTarjeta(a.nombre, a.color, false);
        c._tests = Array.isArray(a.tests) ? a.tests : [];
      });
      actualizarNotasCards();
      actualizarEstadisticas();
    }

    function calcularNotaAsignatura(card) {
      if (!card._tests || card._tests.length === 0) return '-';
      let suma = 0;
      let totalPonderacion = 0;
      card._tests.forEach(t => {
        const nota = parseNumber(t.nota);
        const ponderacion = parseNumber(t.ponderacion);
        suma += nota * ponderacion;
        totalPonderacion += ponderacion;
      });
      if (totalPonderacion === 0) return '-';
      const notaFinal = suma / 100;
      return notaFinal.toFixed(2);
    }

    function actualizarNotasCards() {
      document.querySelectorAll('.card:not(.drag-preview)').forEach(card => {
        const gradeDiv = card.querySelector('.subject-grade');
        if (gradeDiv) {
          const nota = calcularNotaAsignatura(card);
          let emoji = '';

          if (nota !== '-') {
            // Calcular nota acumulada y porcentaje evaluado
            let notaAcumulada = 0;
            let porcentajeEvaluado = 0;

            if (card._tests && card._tests.length > 0) {
              card._tests.forEach(t => {
                const notaTest = parseNumber(t.nota);
                const ponderacion = parseNumber(t.ponderacion);
                notaAcumulada += (notaTest * ponderacion) / 100;
                porcentajeEvaluado += ponderacion;
              });
            }

            porcentajeEvaluado = Math.min(100, porcentajeEvaluado);
            const porcentajeFaltante = 100 - porcentajeEvaluado;

            // Calcular quÃ© nota necesita en lo que falta para aprobar (5.0)
            let notaNecesariaRestante;
            if (porcentajeFaltante > 0) {
              // notaAcumulada + (X * porcentajeFaltante / 100) = 5.0
              // X = (5.0 - notaAcumulada) * 100 / porcentajeFaltante
              notaNecesariaRestante = (5.0 - notaAcumulada) * 100 / porcentajeFaltante;
            } else {
              // Ya estÃ¡ todo evaluado
              notaNecesariaRestante = 0;
            }

            // LÃ³gica de emoji basada en probabilidad de aprobar
            if (porcentajeEvaluado >= 100) {
              // Todo evaluado, usar nota final
              const notaFinal = parseNumber(nota);
              if (notaFinal >= 9) emoji = 'ğŸ‰';
              else if (notaFinal >= 7) emoji = 'ğŸ˜Š';
              else if (notaFinal >= 5) emoji = 'ğŸ™‚';
              else emoji = 'ğŸ˜°';
            } else if (porcentajeEvaluado === 0) {
              // Sin evaluaciones aÃºn
              emoji = 'ğŸ˜';
            } else if (notaNecesariaRestante <= 0) {
              // Ya tiene aprobado seguro (nota acumulada â‰¥ 5.0)
              emoji = 'ğŸ‰';
            } else if (notaNecesariaRestante <= 5) {
              // Necesita â‰¤5 en lo que falta = MUY FÃCIL aprobar
              emoji = 'ğŸ˜Š';
            } else if (notaNecesariaRestante <= 7) {
              // Necesita 5-7 en lo que falta = PROBABLE aprobar
              emoji = 'ğŸ™‚';
            } else if (notaNecesariaRestante <= 10) {
              // Necesita 7-10 en lo que falta = DIFÃCIL pero posible
              emoji = 'ğŸ˜';
            } else {
              // Necesita >10 = IMPOSIBLE aprobar
              emoji = 'ğŸ˜°';
            }
          }

          gradeDiv.textContent = nota + (emoji ? ' ' + emoji : '');
        }
        updateSubjectProgress(card);
      });
      updateAIRecommendation();
      updateDashboard();
    }

    function updateSubjectProgress(card) {
      const percentageText = card.querySelector('.progress-text');
      const bar = card.querySelector('.progress-bar-fill');

      let totalPonderacion = 0;
      if (card._tests && card._tests.length > 0) {
        card._tests.forEach(t => {
          const ponderacion = parseNumber(t.ponderacion);
          totalPonderacion += ponderacion;
        });
      }

      const porcentaje = Math.min(100, totalPonderacion);

      if (percentageText) percentageText.textContent = `Evaluado: ${porcentaje.toFixed(0)}%`;

      if (bar) {
        bar.style.width = `${porcentaje}%`;

        // Color dinÃ¡mico basado en porcentaje
        if (porcentaje < 40) {
          bar.style.backgroundColor = '#ef4444'; // Rojo si es bajo
        } else if (porcentaje < 70) {
          bar.style.backgroundColor = '#f59e0b'; // Naranja/Amarillo medio
        } else if (porcentaje >= 99.5) {
          bar.style.backgroundColor = '#10b981'; // Verde completado
        } else {
          bar.style.backgroundColor = '#facc15'; // Amarillo por defecto
        }
      }
    }

    function actualizarEstadisticas() {
      if (!currentSemester) return;

      const statsDiv = document.getElementById('subjects-stats');
      const cards = document.querySelectorAll('.card:not(.drag-preview)');

      if (cards.length === 0) {
        statsDiv.style.display = 'none';
        return;
      }

      statsDiv.style.display = 'flex';

      // Calcular media
      let sumaNotas = 0;
      let countNotas = 0;
      cards.forEach(card => {
        const nota = calcularNotaAsignatura(card);
        if (nota !== '-') {
          sumaNotas += parseNumber(nota);
          countNotas++;
        }
      });

      const mediaDiv = document.getElementById('stat-average');
      if (countNotas > 0) {
        const media = (sumaNotas / countNotas).toFixed(2);
        let emoji = '';
        const mediaNum = parseNumber(media);
        if (mediaNum < 3) emoji = 'ğŸ˜°';
        else if (mediaNum < 5) emoji = 'ğŸ˜Ÿ';
        else if (mediaNum < 7) emoji = 'ğŸ˜Š';
        else emoji = 'ğŸ‰';
        mediaDiv.textContent = `${media} ${emoji}`;
      } else {
        mediaDiv.textContent = '-';
      }

      // Calcular ECTS totales (6 crÃ©ditos por asignatura aprobada)
      let totalEcts = 0;
      let ectsAprobados = 0;

      cards.forEach(card => {
        totalEcts += 6; // Cada asignatura vale 6 ECTS
        const nota = calcularNotaAsignatura(card);
        if (nota !== '-' && parseNumber(nota) >= 5) {
          ectsAprobados += 6; // Solo contar si estÃ¡ aprobada (nota >= 5)
        }
      });

      const ectsDiv = document.getElementById('stat-ects');
      ectsDiv.textContent = `${ectsAprobados}/${totalEcts}`;
    }

    /* -------------------------
       Crear tarjeta
       ------------------------- */
    function crearTarjeta(nombre = 'Nueva asignatura', color = '#ff4d4d', doGuardar = true, doScroll = false) {
      if (doGuardar) saveStateToHistory('aÃ±adir asignatura');
      const card = document.createElement('div');
      card.className = 'card';
      card.draggable = true;
      card.dataset.color = color;
      card.style.background = color;
      card.style.setProperty('--card-color', color); // Setup for tinted glass
      card._clickCount = 0;
      card._lastClickTime = 0;
      card._tests = [];

      card.innerHTML = `
    <div class="swipe-action-bg left"><span>Eliminar</span></div>
    <div class="swipe-action-bg right"><span>InformaciÃ³n</span></div>
    <div class="card-inner">
      <div class="left">
        <span class="titulo" contenteditable="true" aria-label="Nombre de la asignatura">${escapeHtml(nombre)}</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px; margin-left:auto;">
        <div style="display:flex; align-items:center; gap:6px; font-size:14px; color:#06243b;">
          <span style="font-weight:600;">Nota:</span>
          <div class="subject-grade" style="font-weight:600; min-width:40px; text-align:right;">-</div>
        </div>
        <button class="open-tests-btn" aria-label="Ver pruebas evaluables" title="Ver pruebas" style="background:rgba(255,255,255,0.12); border:none; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:16px; line-height:1; transition: transform 0.2s ease;">ğŸ“</button>
      </div>
    </div>
    <div class="progress-wrapper">
        <div class="progress-text" style="text-align:left; font-size:13px; font-weight:600; margin-bottom:4px; opacity:0.9;">Evaluado: 0%</div>
        <div class="progress-bar-bg" style="width:100%; height:8px; background:rgba(255,255,255,0.3); border-radius:4px; overflow:hidden;">
            <div class="progress-bar-fill" style="width:0%; height:100%; background:#facc15; transition: width 0.3s ease, background-color 0.3s ease;"></div>
        </div>
    </div>
    <div class="controls" aria-hidden="true">
      <label class="sr-only">Color</label>
      <select class="color-select" aria-label="Seleccionar color">
        ${COLOR_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
      </select>
      <button class="progress-toggle-btn" aria-label="Mostrar/ocultar progreso" title="Ver progreso">ğŸ“Š</button>
      <button class="delete-btn" aria-label="Eliminar asignatura" title="Eliminar">âœ–</button>
    </div>
  `;

      const select = card.querySelector('.color-select');
      select.value = color;

      select.addEventListener('change', (e) => {
        card.style.background = e.target.value;
        card.style.setProperty('--card-color', e.target.value);
        card.dataset.color = e.target.value;
        guardar();
      });

      card.querySelector('.delete-btn').addEventListener('click', () => {
        const subjectName = card.querySelector('.titulo').textContent;
        if (confirm(`Â¿Eliminar la asignatura "${subjectName}"?\n\nEsta acciÃ³n no se puede deshacer.`)) {
          saveStateToHistory('eliminar asignatura');
          card.remove();
          guardar();
        }
      });

      // Toggle progreso
      // Toggle progreso
      card.querySelector('.progress-toggle-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const wrapper = card.querySelector('.progress-wrapper');
        const isOpen = wrapper.classList.contains('open');

        if (isOpen) {
          wrapper.classList.remove('open');
        } else {
          wrapper.classList.add('open');
          updateSubjectProgress(card);
        }
      });

      // BotÃ³n para abrir modal de pruebas
      card.querySelector('.open-tests-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        openSubjectDetail(card);
      });

      const titulo = card.querySelector('.titulo');
      let editTimeout = null;
      titulo.addEventListener('input', () => {
        clearTimeout(editTimeout);
        editTimeout = setTimeout(guardar, 500);
      });

      card.addEventListener('dragstart', (ev) => {
        card.classList.add('dragging');
        try { ev.dataTransfer.setData('text/plain', 'drag'); } catch (e) { }
      });
      card.addEventListener('dragend', () => {
        card.classList.remove('dragging');
        guardar();
      });

      card.addEventListener('click', (ev) => {
        const avoid = ev.target.closest('.controls') || ev.target.closest('.delete-btn') || ev.target.closest('.color-select') || ev.target.closest('.titulo') || ev.target.closest('.open-tests-btn');
        if (avoid) return;

        const now = Date.now();
        if (now - card._lastClickTime > 1000) {
          card._clickCount = 0;
        }
        card._lastClickTime = now;
        card._clickCount++;

        if (card._clickCount === 1) {
          document.querySelectorAll('.card.show-controls').forEach(c => c.classList.remove('show-controls'));
          card.classList.add('show-controls');
        } else if (card._clickCount >= 2) {
          openSubjectDetail(card);
          card._clickCount = 0;
        }
      });

      container.appendChild(card);
      if (doGuardar) guardar();
      if (doScroll) {
        card.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }

      return card;
    }

    /* Helper escape HTML */
    function escapeHtml(unsafe) {
      return unsafe
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    /* -------------------------
       ReordenaciÃ³n RATÃ“N (desktop) - MEJORADO
       ------------------------- */
    let dragPreview = null;

    container.addEventListener('dragstart', e => {
      const card = e.target.closest('.card');
      if (!card) return;

      // Ocultar la tarjeta original
      card.style.opacity = '0';

      // Crear preview flotante opaco
      dragPreview = card.cloneNode(true);
      dragPreview.classList.add('drag-preview');
      dragPreview.style.position = 'fixed';
      dragPreview.style.width = card.offsetWidth + 'px';
      dragPreview.style.pointerEvents = 'none';
      dragPreview.style.zIndex = '9999';
      dragPreview.style.opacity = '1';
      document.body.appendChild(dragPreview);

      // Actualizar posiciÃ³n del preview
      const updatePreviewPosition = (ev) => {
        if (dragPreview) {
          dragPreview.style.left = (ev.clientX - card.offsetWidth / 2) + 'px';
          dragPreview.style.top = (ev.clientY - 30) + 'px';
        }
      };

      document.addEventListener('dragover', updatePreviewPosition);

      // Limpiar al soltar
      const cleanup = () => {
        // Restaurar visibilidad de la tarjeta original
        card.style.opacity = '';

        if (dragPreview && dragPreview.parentNode) {
          dragPreview.remove();
        }
        dragPreview = null;
        document.removeEventListener('dragover', updatePreviewPosition);
        document.removeEventListener('dragend', cleanup);
        document.querySelectorAll('.drop-zone-active').forEach(el => el.classList.remove('drop-zone-active'));
      };

      document.addEventListener('dragend', cleanup, { once: true });
    });

    container.addEventListener('dragover', e => {
      e.preventDefault();
      const dragging = document.querySelector('.dragging');
      if (!dragging) return;

      const prevRects = new Map();
      [...container.querySelectorAll('.card:not(.dragging)')].forEach(c => prevRects.set(c, c.getBoundingClientRect()));

      const cards = [...container.querySelectorAll('.card:not(.dragging)')];

      // Remover clase anterior
      cards.forEach(c => c.classList.remove('drop-zone-active'));

      // Encontrar siguiente tarjeta y marcar drop zone
      const next = cards.find(c => e.clientY <= c.getBoundingClientRect().top + c.offsetHeight / 2);
      if (next) {
        next.classList.add('drop-zone-active');
      } else if (cards.length > 0) {
        cards[cards.length - 1].classList.add('drop-zone-active');
      }

      container.insertBefore(dragging, next || null);

      requestAnimationFrame(() => runFLIP(prevRects));
    });

    /* -------------------------
       ReordenaciÃ³n TOUCH (mÃ³vil) - MEJORADO CON GESTOS
       ------------------------- */
    let touchCard = null;
    let startY = 0;
    let startX = 0;
    let moved = false;
    let isDraggingFromHandle = false;
    let swipeDirection = null;
    let longPressTimer = null;
    const MOVE_THRESHOLD = 10;
    const SWIPE_THRESHOLD = 80;
    const LONG_PRESS_DURATION = 500;

    container.addEventListener('touchstart', (e) => {
      const el = e.target.closest('.card');

      if (!el) return;

      isDraggingFromHandle = false;
      touchCard = el;
      startY = e.touches[0].clientY;
      startX = e.touches[0].clientX;
      moved = false;
      swipeDirection = null;
    }, { passive: true });

    container.addEventListener('touchmove', (e) => {
      // Cancelar long press si se mueve
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }

      if (!touchCard) return;

      const y = e.touches[0].clientY;
      const x = e.touches[0].clientX;
      const deltaX = x - startX;
      const deltaY = y - startY;

      if (Math.abs(deltaY) > MOVE_THRESHOLD || Math.abs(deltaX) > MOVE_THRESHOLD) {
        moved = true;
      }

      // Detectar swipe horizontal (solo si no es drag desde handle)
      if (!isDraggingFromHandle && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 20) {
        e.preventDefault();

        // Limitar desplazamiento a la mitad del ancho de la tarjeta
        const cardWidth = touchCard.offsetWidth;
        const maxSwipe = cardWidth / 2;
        const limitedDeltaX = Math.max(-maxSwipe, Math.min(maxSwipe, deltaX));

        // Aplicar transformaciÃ³n visual del swipe (solo horizontal, eje vertical fijo)
        touchCard.classList.add('swiping');
        touchCard.style.transform = `translateX(${limitedDeltaX}px)`;

        // Mostrar/ocultar fondos de acciÃ³n con opacidad progresiva
        const leftBg = touchCard.querySelector('.swipe-action-bg.left');
        const rightBg = touchCard.querySelector('.swipe-action-bg.right');

        // Calcular opacidad basada en el progreso del swipe (0 a 1)
        const swipeProgress = Math.abs(limitedDeltaX) / maxSwipe;

        if (deltaX < -20) {
          // Swipe izquierda - mostrar "Eliminar" con opacidad progresiva
          leftBg.classList.add('visible');
          leftBg.style.opacity = swipeProgress;
          rightBg.classList.remove('visible');
          rightBg.style.opacity = '0';
          if (deltaX < -SWIPE_THRESHOLD) {
            swipeDirection = 'left';
          } else {
            swipeDirection = null;
          }
        } else if (deltaX > 20) {
          // Swipe derecha - mostrar "InformaciÃ³n" con opacidad progresiva
          rightBg.classList.add('visible');
          rightBg.style.opacity = swipeProgress;
          leftBg.classList.remove('visible');
          leftBg.style.opacity = '0';
          if (deltaX > SWIPE_THRESHOLD) {
            swipeDirection = 'right';
          } else {
            swipeDirection = null;
          }
        } else {
          leftBg.classList.remove('visible');
          rightBg.classList.remove('visible');
          leftBg.style.opacity = '0';
          rightBg.style.opacity = '0';
          swipeDirection = null;
        }
        return;
      }

      // Drag vertical para reordenar (solo desde handle)
      if (isDraggingFromHandle && moved) {
        e.preventDefault();
        const cards = [...container.querySelectorAll('.card:not(.dragging)')];
        const next = cards.find(c => y <= c.getBoundingClientRect().top + c.offsetHeight / 2);
        container.insertBefore(touchCard, next || null);
      }
    }, { passive: false });

    container.addEventListener('touchend', (e) => {
      // Cancelar long press
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }

      if (!touchCard) return;

      const deltaX = e.changedTouches[0].clientX - startX;

      // Ocultar fondos de acciÃ³n
      const leftBg = touchCard.querySelector('.swipe-action-bg.left');
      const rightBg = touchCard.querySelector('.swipe-action-bg.right');
      if (leftBg) {
        leftBg.classList.remove('visible');
        leftBg.style.opacity = '0';
      }
      if (rightBg) {
        rightBg.classList.remove('visible');
        rightBg.style.opacity = '0';
      }

      // Manejar swipe completado
      if (swipeDirection && Math.abs(deltaX) > SWIPE_THRESHOLD) {
        if (swipeDirection === 'left') {
          // Swipe izquierda = ELIMINAR
          const subjectName = touchCard.querySelector('.titulo').textContent;
          if (confirm(`Â¿Eliminar la asignatura "${subjectName}"?\n\nEsta acciÃ³n no se puede deshacer.`)) {
            saveStateToHistory('eliminar asignatura');

            // Eliminar del array de datos primero
            if (currentSemester && currentSemester.asignaturas) {
              const cuatrimestres = obtenerCuatrimestres();
              const idx = cuatrimestres.findIndex(c => c.id === currentSemester.id);
              if (idx !== -1) {
                // Filtrar la asignatura por nombre
                cuatrimestres[idx].asignaturas = cuatrimestres[idx].asignaturas.filter(a => a.nombre !== subjectName);
                currentSemester.asignaturas = cuatrimestres[idx].asignaturas;
                localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
              }
            }

            // Eliminar inmediatamente del DOM sin animaciÃ³n
            touchCard.remove();

            // Actualizar UI
            actualizarNotasCards();
            actualizarEstadisticas();
            scheduleSyncToFirebase();
          } else {
            // Cancelar - resetear visual
            touchCard.style.transform = '';
            touchCard.classList.remove('swiping');
          }
        } else if (swipeDirection === 'right') {
          // Swipe derecha = MOSTRAR INFORMACIÃ“N (abrir modal)
          openSubjectDetail(touchCard);

          // Resetear visual
          touchCard.style.transform = '';
          touchCard.classList.remove('swiping');
        }
      } else {
        // Cancelar swipe incompleto
        touchCard.style.transform = '';
        touchCard.classList.remove('swiping');
      }

      touchCard.classList.remove('dragging');

      if (moved && isDraggingFromHandle) {
        guardar();
      }

      touchCard = null;
      isDraggingFromHandle = false;
      moved = false;
      swipeDirection = null;
    }, { passive: true });

    document.addEventListener('touchstart', (e) => {
      const c = e.target.closest('.card');
      if (!c) {
        document.querySelectorAll('.card.show-controls').forEach(card => card.classList.remove('show-controls'));
      }
    }, { passive: true });

    document.addEventListener('click', (e) => {
      const c = e.target.closest('.card');
      if (!c) {
        document.querySelectorAll('.card.show-controls').forEach(card => card.classList.remove('show-controls'));
      }
    });

    /* -------------------------
       AÃ±adir tarjeta
       ------------------------- */
    ADD_BTN.addEventListener('click', () => {
      crearTarjeta('Nueva asignatura', '#ff4d4d', true, true);
    });

    /* -------------------------
       Carga inicial
       ------------------------- */
    // Esperar a que el DOM estÃ© completamente cargado
    document.addEventListener('DOMContentLoaded', () => {
      initThemeMode();
      showMenuScreen();
      initScrollHideUI();
      // Soporte de rotaciÃ³n: aÃ±adir clase a body segÃºn orientaciÃ³n
      function setOrientationClass() {
        const isLandscape = window.matchMedia('(orientation: landscape)').matches || (window.innerWidth > window.innerHeight);
        document.body.classList.toggle('landscape', isLandscape);
        document.body.classList.toggle('portrait', !isLandscape);
      }
      setOrientationClass();
      window.addEventListener('orientationchange', setOrientationClass);
      window.addEventListener('resize', setOrientationClass);

      // Local Notifications Permission
      const hasAskedNotifications = localStorage.getItem('notificationsAsked');
      if (!hasAskedNotifications && 'Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        // Mark as asked IMMEDIATELY so we don't ask again on refresh
        localStorage.setItem('notificationsAsked', 'true');

        setTimeout(() => {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              console.log('Notificaciones activadas');
              checkExamAlerts(); // Re-check with permissions
            }
          });
        }, 3000);
      }
    });

    /* -------------------------
       Modal / detalle de asignatura
       ------------------------- */

    // construir estructura modal (insertada en body)
    const modalHtml = `
  <div class="modal-overlay" id="subject-modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-header" id="modal-header">
        <div>
          <h2 class="modal-title" id="modal-title"></h2>
          <div style="display:flex; align-items:center; gap:6px; font-size:14px; color:rgba(255,255,255,0.8); margin-top:4px;">
            <span>Nota:</span>
            <span id="modal-grade" style="font-weight:600;">-</span>
          </div>
        </div>
        <div>
          <button class="btn btn-ghost" id="close-modal">Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <strong>Pruebas evaluables</strong>
          <button class="btn btn-primary" id="add-test-btn" style="padding: 6px 10px; font-size: 14px;">+ AÃ±adir prueba</button>
        </div>
        <div class="tests-list" id="tests-list"></div>
      </div>

    </div>
  </div>
`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Bottom-sheets para crear/editar/eliminar cuatrimestres (inserciÃ³n mÃ­nima)
    const sheetsHtml = `
  <div class="sheet-overlay" id="create-sheet">
    <div class="bottom-sheet">
      <h3>Crear cuatrimestre</h3>
      <label class="sheet-label">Introduce el curso (aÃ±o)</label>
      <input id="create-curso" class="sheet-input" type="text" placeholder="2025/26">
      <label class="sheet-label">Introduce el cuatrimestre</label>
      <input id="create-cuatri" class="sheet-input" type="text" placeholder="1">
      <div class="sheet-actions">
        <button id="create-cancel" class="btn btn-ghost">Cancelar</button>
        <button id="create-confirm" class="btn btn-primary">Crear curso</button>
      </div>
    </div>
  </div>

  <div class="sheet-overlay" id="edit-sheet">
    <div class="bottom-sheet">
      <h3>Editar nombre del cuatrimestre</h3>
      <label class="sheet-label">Nuevo nombre</label>
      <input id="edit-name" class="sheet-input" type="text">
      <div class="sheet-actions">
        <button id="edit-cancel" class="btn btn-ghost">Cancelar</button>
        <button id="edit-save" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <div class="sheet-overlay" id="delete-sheet">
    <div class="bottom-sheet delete">
      <div style="display:flex;align-items:center;gap:14px;">
        <div class="warning-icon">!</div>
        <div>
          <h3>Eliminar cuatrimestre</h3>
          <div id="delete-name" style="color:#475569;margin-top:6px;font-weight:600;"></div>
        </div>
      </div>
      <p style="color:#64748b;margin-top:12px;">Esta acciÃ³n no se puede deshacer.</p>
      <div class="sheet-actions">
        <button id="delete-cancel" class="btn btn-ghost">Cancelar</button>
        <button id="delete-confirm" class="btn" style="background:#dc2626;color:white;">Eliminar</button>
      </div>
    </div>
  </div>

  <div class="sheet-overlay" id="duplicate-sheet">
    <div class="bottom-sheet">
      <h3>Duplicar cuatrimestre</h3>
      <p style="color:#64748b;margin-bottom:12px;">Se copiarÃ¡n las asignaturas sin las notas.</p>
      <label class="sheet-label">Nombre del nuevo cuatrimestre</label>
      <input id="duplicate-name" class="sheet-input" type="text" placeholder="Curso 2025/26 - Cuatrimestre 2">
      <div class="sheet-actions">
        <button id="duplicate-cancel" class="btn btn-ghost">Cancelar</button>
        <button id="duplicate-confirm" class="btn btn-primary">Duplicar</button>
      </div>
    </div>
  </div>
`;
    document.body.insertAdjacentHTML('beforeend', sheetsHtml);

    // Referencias y lÃ³gica de los sheets
    const createSheet = document.getElementById('create-sheet');
    const createCurso = document.getElementById('create-curso');
    const createCuatri = document.getElementById('create-cuatri');
    const createCancel = document.getElementById('create-cancel');
    const createConfirm = document.getElementById('create-confirm');

    const editSheet = document.getElementById('edit-sheet');
    const editNameInput = document.getElementById('edit-name');
    const editCancel = document.getElementById('edit-cancel');
    const editSave = document.getElementById('edit-save');

    const deleteSheet = document.getElementById('delete-sheet');
    const deleteName = document.getElementById('delete-name');
    const deleteCancel = document.getElementById('delete-cancel');
    const deleteConfirm = document.getElementById('delete-confirm');

    const duplicateSheet = document.getElementById('duplicate-sheet');
    const duplicateNameInput = document.getElementById('duplicate-name');
    const duplicateCancel = document.getElementById('duplicate-cancel');
    const duplicateConfirm = document.getElementById('duplicate-confirm');

    let _editingSemester = null;
    let _deletingSemesterId = null;
    let _duplicatingSemester = null;

    function openCreateSheet() {
      createCurso.value = '';
      createCuatri.value = '';
      createSheet.classList.add('show');
      setTimeout(() => createCurso.focus(), 120);
    }
    function closeCreateSheet() { createSheet.classList.remove('show'); }

    createCancel.addEventListener('click', () => closeCreateSheet());
    createSheet.addEventListener('click', (e) => { if (e.target === createSheet) closeCreateSheet(); });

    createConfirm.addEventListener('click', () => {
      const aÃ±o = (createCurso.value || '').trim();
      const cuatri = (createCuatri.value || '').trim();
      if (!aÃ±o || !cuatri) return; // simple guard
      saveStateToHistory('crear cuatrimestre');
      const nombre = `Curso ${aÃ±o} - Cuatrimestre ${cuatri}`;
      const cuatrimestres = obtenerCuatrimestres();
      cuatrimestres.push({ id: Date.now(), nombre: nombre, asignaturas: [] });
      localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
      closeCreateSheet();
      renderSemesters();
    });

    // Edit sheet
    function openEditSheet(sem) {
      _editingSemester = sem;
      editNameInput.value = sem.nombre || '';
      editSheet.classList.add('show');
      setTimeout(() => editNameInput.focus(), 120);
    }
    function closeEditSheet() { editSheet.classList.remove('show'); _editingSemester = null; }
    editCancel.addEventListener('click', () => closeEditSheet());
    editSheet.addEventListener('click', (e) => { if (e.target === editSheet) closeEditSheet(); });

    editSave.addEventListener('click', () => {
      if (!_editingSemester) return;
      const newName = (editNameInput.value || '').trim();
      if (!newName) return;
      saveStateToHistory('editar cuatrimestre');
      _editingSemester.nombre = newName;
      const cuatrimestres = obtenerCuatrimestres();
      const idx = cuatrimestres.findIndex(c => c.id === _editingSemester.id);
      if (idx !== -1) {
        cuatrimestres[idx] = _editingSemester;
        localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
      }
      closeEditSheet();
      renderSemesters();
    });

    // Delete sheet
    function openDeleteSheet(sem) {
      _deletingSemesterId = sem.id;
      deleteName.textContent = sem.nombre || '';
      deleteSheet.classList.add('show');
    }
    function closeDeleteSheet() { deleteSheet.classList.remove('show'); _deletingSemesterId = null; }
    deleteCancel.addEventListener('click', () => closeDeleteSheet());
    deleteSheet.addEventListener('click', (e) => { if (e.target === deleteSheet) closeDeleteSheet(); });

    deleteConfirm.addEventListener('click', () => {
      if (_deletingSemesterId == null) return;
      saveStateToHistory('eliminar cuatrimestre');
      deleteSemester(_deletingSemesterId);
      closeDeleteSheet();
    });

    // Duplicate sheet
    function openDuplicateSheet(sem) {
      _duplicatingSemester = sem;
      duplicateNameInput.value = sem.nombre + ' (copia)';
      duplicateSheet.classList.add('show');
      setTimeout(() => duplicateNameInput.focus(), 120);
    }
    function closeDuplicateSheet() {
      duplicateSheet.classList.remove('show');
      _duplicatingSemester = null;
    }
    duplicateCancel.addEventListener('click', () => closeDuplicateSheet());
    duplicateSheet.addEventListener('click', (e) => { if (e.target === duplicateSheet) closeDuplicateSheet(); });

    duplicateConfirm.addEventListener('click', () => {
      if (!_duplicatingSemester) return;
      const newName = (duplicateNameInput.value || '').trim();
      if (!newName) return;

      saveStateToHistory('duplicar cuatrimestre');
      const cuatrimestres = obtenerCuatrimestres();
      const newSemester = {
        id: Date.now(),
        nombre: newName,
        archived: false,
        asignaturas: _duplicatingSemester.asignaturas.map(a => ({
          nombre: a.nombre,
          color: a.color,
          tests: []
        }))
      };

      cuatrimestres.push(newSemester);
      localStorage.setItem('cuatrimestres', JSON.stringify(cuatrimestres));
      closeDuplicateSheet();
      renderSemesters();
    });


    const subjectModal = document.getElementById('subject-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalHeader = document.getElementById('modal-header');
    const testsList = document.getElementById('tests-list');
    const closeModal = document.getElementById('close-modal');
    const addTestBtn = document.getElementById('add-test-btn');

    let activeCard = null;

    function openSubjectDetail(card) {
      activeCard = card;
      modalTitle.textContent = card.querySelector('.titulo').textContent || 'Asignatura';
      // header gradient suave usando color de la tarjeta (claro a oscuro)
      const color = card.dataset.color || '#007bff';
      const lightColor = getLighterColor(color);
      const darkColor = getDarkerColor(color);
      modalHeader.style.background = `linear-gradient(to right, ${lightColor}, ${darkColor})`;
      // texto claro/oscuro segun contraste
      modalTitle.style.color = getContrastingText(color);
      // mostrar nota en el modal
      const modalGrade = document.getElementById('modal-grade');
      if (modalGrade) {
        modalGrade.textContent = calcularNotaAsignatura(card);
      }
      // render tests
      renderTests();
      subjectModal.classList.add('show');
    }

    function closeSubjectDetail(save = true) {
      if (!activeCard) return;
      if (save) guardar();
      subjectModal.classList.remove('show');
      activeCard = null;
    }

    closeModal.addEventListener('click', () => closeSubjectDetail(false));

    // Cerrar modal al hacer clic fuera de ella (en el overlay)
    subjectModal.addEventListener('click', (e) => {
      if (e.target === subjectModal) {
        closeSubjectDetail(false);
      }
    });

    addTestBtn.addEventListener('click', () => {
      if (!activeCard) return;
      activeCard._tests.push({ nombre: 'Nueva prueba', nota: '' });
      renderTests();
      guardar();
    });

    function renderTests() {
      testsList.innerHTML = '';
      if (!activeCard) return;
      activeCard._tests = activeCard._tests || [];

      // Ordenar pruebas: parciales/teorÃ­a arriba, prÃ¡cticas abajo, por nÃºmero
      const sortedTests = [...activeCard._tests].sort((a, b) => {
        const nameA = (a.nombre || '').toLowerCase();
        const nameB = (b.nombre || '').toLowerCase();

        // Detectar tipo (prÃ¡ctica vs parcial/teorÃ­a)
        const isPracticaA = nameA.includes('prÃ¡ctica') || nameA.includes('practica');
        const isPracticaB = nameB.includes('prÃ¡ctica') || nameB.includes('practica');

        // Primero ordenar por tipo: parciales/teorÃ­a (false) antes que prÃ¡cticas (true)
        if (isPracticaA !== isPracticaB) {
          return isPracticaA ? 1 : -1;
        }

        // Extraer nÃºmero del nombre (buscar primer nÃºmero)
        const numA = parseInt(nameA.match(/\d+/)?.[0] || '999');
        const numB = parseInt(nameB.match(/\d+/)?.[0] || '999');

        // Ordenar por nÃºmero
        if (numA !== numB) {
          return numA - numB;
        }

        // Si tienen el mismo nÃºmero, ordenar alfabÃ©ticamente
        return nameA.localeCompare(nameB);
      });

      sortedTests.forEach((t, idx) => {
        // Encontrar Ã­ndice original para mantener referencias correctas
        const originalIdx = activeCard._tests.indexOf(t);
        const row = document.createElement('div');
        row.className = 'test-row';
        row.innerHTML = `
      <input class="test-name" type="text" value="${escapeHtml(t.nombre)}" aria-label="Nombre prueba ${idx + 1}">
      <label style="display:flex; align-items:center; gap:6px; font-size:14px; color:#475569;">
        Nota: <input class="test-grade" type="text" value="${escapeHtml(String(t.nota || ''))}" aria-label="Nota prueba ${idx + 1}">
      </label>
      <label style="display:flex; align-items:center; gap:6px; font-size:14px; color:#475569;">
        PonderaciÃ³n: <input class="test-weight" type="text" value="${escapeHtml(String(t.ponderacion || ''))}" aria-label="PonderaciÃ³n prueba ${idx + 1}"><span style="margin-left: 4px; font-weight: 600;">%</span>
      </label>
      <div class="test-actions"><button class="btn btn-delete delete-test">Eliminar</button></div>
    `;
        const nameInput = row.querySelector('.test-name');
        const gradeInput = row.querySelector('.test-grade');
        const weightInput = row.querySelector('.test-weight');
        const delBtn = row.querySelector('.delete-test');

        nameInput.addEventListener('input', (e) => {
          activeCard._tests[originalIdx].nombre = e.target.value;
          guardar();
        });

        // Re-renderizar solo cuando termine de editar para aplicar ordenamiento
        nameInput.addEventListener('blur', () => {
          renderTests();
        });

        nameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.target.blur();
          }
        });

        gradeInput.addEventListener('input', (e) => {
          activeCard._tests[originalIdx].nota = e.target.value;
          guardar();
        });
        weightInput.addEventListener('input', (e) => {
          activeCard._tests[originalIdx].ponderacion = e.target.value;
          guardar();
        });
        delBtn.addEventListener('click', () => {
          if (confirm('Â¿EstÃ¡s seguro de que deseas eliminar esta prueba evaluable?')) {
            activeCard._tests.splice(originalIdx, 1);
            renderTests();
            guardar();
          }
        });

        testsList.appendChild(row);
      });
      if (sortedTests.length === 0) {
        testsList.innerHTML = '<div style="color:#475569">No hay pruebas. Pulsa "AÃ±adir prueba" para crear una.</div>';
      }
      actualizarNotasCards();
      // actualizar nota en el modal tambiÃ©n
      const modalGrade = document.getElementById('modal-grade');
      if (modalGrade) {
        modalGrade.textContent = calcularNotaAsignatura(activeCard);
      }
    }

    // utilidad: contraste de texto sobre color de fondo
    function getContrastingText(hex) {
      try {
        const rgb = hexToRgb(hex);
        const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
        return brightness > 150 ? '#0f172a' : '#ffffff';
      } catch (e) { return '#ffffff'; }
    }
    function hexToRgb(hex) {
      const h = hex.replace('#', '');
      if (h.length === 3) {
        return { r: parseInt(h[0] + h[0], 16), g: parseInt(h[1] + h[1], 16), b: parseInt(h[2] + h[2], 16) };
      }
      return { r: parseInt(h.slice(0, 2), 16), g: parseInt(h.slice(2, 4), 16), b: parseInt(h.slice(4, 6), 16) };
    }

    // Helpers para generar versiones claras y oscuras del color
    function getLighterColor(hex) {
      const rgb = hexToRgb(hex);
      // aumentar luminosidad: mezclar con blanco
      const lighter = {
        r: Math.min(255, Math.round(rgb.r * 0.6 + 255 * 0.4)),
        g: Math.min(255, Math.round(rgb.g * 0.6 + 255 * 0.4)),
        b: Math.min(255, Math.round(rgb.b * 0.6 + 255 * 0.4))
      };
      return `rgb(${lighter.r}, ${lighter.g}, ${lighter.b})`;
    }

    function getDarkerColor(hex) {
      const rgb = hexToRgb(hex);
      // disminuir luminosidad: mezclar con negro
      const darker = {
        r: Math.round(rgb.r * 0.5),
        g: Math.round(rgb.g * 0.5),
        b: Math.round(rgb.b * 0.5)
      };
      return `rgb(${darker.r}, ${darker.g}, ${darker.b})`;
    }

    /* -------------------------
       Changelog desde GitHub
       ------------------------- */
    const GITHUB_REPO = 'rodalca03/studyboard';
    const CHANGELOG_API = `https://api.github.com/repos/${GITHUB_REPO}/commits`;

    let versionClickCount = 0;
    let versionClickTimer = null;

    function openChangelog() {
      const modal = document.getElementById('changelog-modal');
      if (!modal) return;

      modal.style.display = 'flex';
      setTimeout(() => {
        modal.classList.add('show');
      }, 10);
      loadChangelog();
    }

    function closeChangelog() {
      const modal = document.getElementById('changelog-modal');
      if (!modal) return;
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 250);
    }

    async function loadChangelog() {
      const content = document.getElementById('changelog-content');
      if (!content) return;

      try {
        const response = await fetch(CHANGELOG_API + '?per_page=50');
        if (!response.ok) throw new Error('Error al cargar changelog');

        const commits = await response.json();

        // Agrupar commits por versiÃ³n
        const versions = {};
        const versionRegex = /v(\d+)\.(\d+)\.(\d+)/;

        commits.forEach(commit => {
          const message = commit.commit.message;
          const match = message.match(versionRegex);

          if (match) {
            const version = match[0];
            if (!versions[version]) {
              versions[version] = {
                commits: [],
                date: commit.commit.author.date,
                major: parseInt(match[1]),
                minor: parseInt(match[2]),
                patch: parseInt(match[3])
              };
            }
            versions[version].commits.push({
              message: message.replace(/\(v.*?\)/, '').trim(),
              sha: commit.sha.substring(0, 7),
              date: commit.commit.author.date
            });
          }
        });

        // Ordenar versiones (mÃ¡s reciente primero)
        const sortedVersions = Object.keys(versions).sort((a, b) => {
          const vA = versions[a];
          const vB = versions[b];
          if (vA.major !== vB.major) return vB.major - vA.major;
          if (vA.minor !== vB.minor) return vB.minor - vA.minor;
          return vB.patch - vA.patch;
        });

        // Generar HTML
        let html = '';
        sortedVersions.forEach(version => {
          const v = versions[version];
          const versionType = getVersionType(v);
          const date = new Date(v.date).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });

          html += `
        <div class="changelog-version">
          <div class="changelog-version-header">
            <h3>
              <span class="version-badge ${versionType}">${version}</span>
              <span class="version-type-label">${getVersionTypeLabel(versionType)}</span>
            </h3>
            <span class="changelog-date">${date}</span>
          </div>
          <ul class="changelog-list">
      `;

          v.commits.forEach(commit => {
            const icon = getCommitIcon(commit.message);
            html += `
          <li>
            <span class="commit-icon">${icon}</span>
            <span>${escapeHtml(commit.message.split('\n')[0])}</span>
            <code class="commit-sha">${commit.sha}</code>
          </li>
        `;
          });

          html += `
          </ul>
        </div>
      `;
        });

        if (html === '') {
          html = '<p style="text-align: center; color: #94a3b8; padding: 40px;">No se encontraron versiones en el historial.</p>';
        }

        content.innerHTML = html;

      } catch (error) {
        console.error('Error loading changelog:', error);
        content.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #ef4444;">
        <p style="font-size: 48px; margin: 0;">âš ï¸</p>
        <p style="margin: 16px 0 0 0;">Error al cargar el historial de cambios</p>
        <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 14px;">${error.message}</p>
      </div>
    `;
      }
    }

    function getVersionType(version) {
      if (version.minor === 0 && version.patch === 0) return 'major';
      if (version.patch === 0) return 'minor';
      return 'patch';
    }

    function getVersionTypeLabel(type) {
      switch (type) {
        case 'major': return 'ğŸš€ VersiÃ³n Mayor';
        case 'minor': return 'âœ¨ Nueva Funcionalidad';
        case 'patch': return 'ğŸ”§ CorrecciÃ³n';
        default: return '';
      }
    }

    function getCommitIcon(message) {
      const msg = message.toLowerCase();
      if (msg.startsWith('feat:')) return 'âœ¨';
      if (msg.startsWith('fix:')) return 'ğŸ›';
      if (msg.startsWith('docs:')) return 'ğŸ“';
      if (msg.startsWith('style:')) return 'ğŸ’„';
      if (msg.startsWith('refactor:')) return 'â™»ï¸';
      if (msg.startsWith('perf:')) return 'âš¡';
      if (msg.startsWith('test:')) return 'âœ…';
      if (msg.startsWith('chore:')) return 'ğŸ”§';
      return 'ğŸ“¦';
    }

    // Event listeners para changelog
    function initChangelogListeners() {
      const versionBadge = document.getElementById('version-badge');
      const changelogBtn = document.getElementById('changelog-btn');
      const closeBtn = document.getElementById('close-changelog');
      const showTutorialBtn = document.getElementById('show-tutorial-btn');
      const changelogModal = document.getElementById('changelog-modal');

      if (versionBadge) {
        // Click simple para abrir changelog
        versionBadge.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          openChangelog();
        });
      }

      if (changelogBtn) {
        // BotÃ³n discreto en el menÃº principal
        changelogBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          openChangelog();
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', closeChangelog);
      }

      if (showTutorialBtn) {
        showTutorialBtn.addEventListener('click', () => {
          closeChangelog();
          setTimeout(() => showOnboarding(), 300);
        });
      }
      const testIosBtn = document.getElementById('test-ios-btn');
      if (testIosBtn) {
        testIosBtn.addEventListener('click', () => {
          if (isIOS()) {
            openGlassSuggestion();
          } else {
            openGlassSuggestion(); // Permitir probar tambiÃ©n en otros dispositivos
          }
        });
      }

      if (changelogModal) {
        changelogModal.addEventListener('click', (e) => {
          if (e.target === changelogModal) closeChangelog();
        });
      }
    }

    // Ejecutar inmediatamente y tambiÃ©n en DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initChangelogListeners);
    } else {
      initChangelogListeners();
    }

    /* -------------------------
       Sistema de Onboarding/Tutorial
       ------------------------- */
    let currentSlide = 0;
    let autoPlayInterval = null;
    const AUTOPLAY_DELAY = 4000; // 3 segundos por slide

    function showOnboarding() {
      const modal = document.getElementById('onboarding-modal');
      if (!modal) return;

      modal.style.display = 'flex';
      currentSlide = 0;
      updateSlide();
      startAutoPlay();

      // Aviso si no hay cÃ³digo de sincronizaciÃ³n activo
      try {
        const syncCode = localStorage.getItem('syncCode');
        const container = modal.querySelector('.onboarding-container');
        let warning = container.querySelector('.onboarding-warning');
        if (!syncCode) {
          if (!warning) {
            warning = document.createElement('div');
            warning.className = 'onboarding-warning';
            warning.innerHTML = 'Si no quiere ver mÃ¡s esta ventana, cree un cÃ³digo de sincronizaciÃ³n en la nube.';
            container.appendChild(warning);
          }
          warning.style.display = 'block';
        } else if (warning) {
          warning.style.display = 'none';
        }
      } catch (e) { }
    }

    function hideOnboarding() {
      const modal = document.getElementById('onboarding-modal');
      if (!modal) return;

      stopAutoPlay();
      modal.style.display = 'none';
      // Marcar que el usuario ya vio el tutorial al menos una vez
      localStorage.setItem('onboardingSeenOnce', 'true');
      // Tras cerrar tutorial, sugerir Liquid Glass si es iOS
      if (isIOS()) {
        openGlassSuggestion();
      }
    }

    function updateSlide() {
      const slides = document.querySelectorAll('.onboarding-slide');
      const dots = document.querySelectorAll('.onboarding-dots .dot');
      const prevBtn = document.getElementById('prev-slide');
      const nextBtn = document.getElementById('next-slide');
      const finishBtn = document.getElementById('finish-onboarding');

      slides.forEach((slide, index) => {
        slide.classList.toggle('active', index === currentSlide);
      });

      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlide);
      });

      // Mostrar/ocultar botones
      prevBtn.style.display = currentSlide === 0 ? 'none' : 'inline-block';
      nextBtn.style.display = currentSlide === slides.length - 1 ? 'none' : 'inline-block';
      finishBtn.style.display = currentSlide === slides.length - 1 ? 'inline-block' : 'none';
    }

    function nextSlide() {
      const slides = document.querySelectorAll('.onboarding-slide');
      if (currentSlide < slides.length - 1) {
        currentSlide++;
        updateSlide();
        resetAutoPlay();
      }
    }

    function prevSlide() {
      if (currentSlide > 0) {
        currentSlide--;
        updateSlide();
        resetAutoPlay();
      }
    }

    function startAutoPlay() {
      stopAutoPlay();
      autoPlayInterval = setInterval(() => {
        const slides = document.querySelectorAll('.onboarding-slide');
        if (currentSlide < slides.length - 1) {
          nextSlide();
        } else {
          stopAutoPlay();
        }
      }, AUTOPLAY_DELAY);
    }

    function stopAutoPlay() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
      }
    }

    function resetAutoPlay() {
      stopAutoPlay();
      startAutoPlay();
    }

    // Event listeners para onboarding
    document.addEventListener('DOMContentLoaded', () => {
      const skipBtn = document.getElementById('skip-onboarding');
      const prevBtn = document.getElementById('prev-slide');
      const nextBtn = document.getElementById('next-slide');
      const finishBtn = document.getElementById('finish-onboarding');

      if (skipBtn) skipBtn.addEventListener('click', hideOnboarding);
      if (prevBtn) prevBtn.addEventListener('click', prevSlide);
      if (nextBtn) nextBtn.addEventListener('click', nextSlide);
      if (finishBtn) finishBtn.addEventListener('click', hideOnboarding);

      // Click en dots para navegar
      document.querySelectorAll('.onboarding-dots .dot').forEach((dot, index) => {
        dot.addEventListener('click', () => {
          currentSlide = index;
          updateSlide();
          resetAutoPlay();
        });
      });

      // Pausar autoplay al hacer hover
      const onboardingContainer = document.querySelector('.onboarding-container');
      if (onboardingContainer) {
        onboardingContainer.addEventListener('mouseenter', stopAutoPlay);
        onboardingContainer.addEventListener('mouseleave', startAutoPlay);
      }

      // Mostrar onboarding si no se ha completado Y no hay cÃ³digo de sincronizaciÃ³n
      const seenOnce = localStorage.getItem('onboardingSeenOnce') === 'true';
      const syncCode = localStorage.getItem('syncCode');
      // Regla: mostrar al menos una vez; despuÃ©s, seguir mostrando si NO hay cÃ³digo de sincronizaciÃ³n
      const shouldShow = !seenOnce || !syncCode;
      if (shouldShow) {
        setTimeout(() => { showOnboarding(); }, 500);
      } else {
        // Si no se debe mostrar el tutorial y es iOS, mostrar sugerencia directamente
        if (isIOS()) {
          setTimeout(() => { openGlassSuggestion(); }, 600);
        }
        // Para Android: mostrar sugerencia cada 100 aperturas si no se usa glass
        try {
          const theme = localStorage.getItem('themeMode') || 'light';
          let launchCount = parseInt(localStorage.getItem('launchCount') || '0', 10) || 0;
          launchCount += 1;
          localStorage.setItem('launchCount', String(launchCount));
          if (isAndroid() && theme !== 'glass' && launchCount % 100 === 0) {
            setTimeout(() => { openGlassSuggestion(); }, 700);
          }
        } catch (e) { }
      }
    });

    // FLIP animation helper: calcula deltas y anima transform para movimiento suave
    function runFLIP(prevRects) {
      // Animar sÃ³lo los elementos que estaban presente en prevRects (excluimos el elemento que se arrastra)
      const els = Array.from(prevRects.keys());
      els.forEach(card => {
        // obtener nueva posiciÃ³n
        const prev = prevRects.get(card);
        if (!prev) return;
        const next = card.getBoundingClientRect();
        const dy = prev.top - next.top;
        if (dy === 0) return;

        // inicialmente aplicamos transform inversa sin transiciÃ³n
        card.style.transition = 'none';
        card.style.transform = `translateY(${dy}px)`;
        // forzar reflow para asegurar que el browser registre el cambio
        // eslint-disable-next-line no-unused-expressions
        card.offsetHeight;

        // en el siguiente frame animamos hacia 0
        requestAnimationFrame(() => {
          // suavizar: duraciÃ³n algo mayor y easing mÃ¡s suave
          card.style.transition = 'transform .36s cubic-bezier(.2,.8,.2,1)';
          card.style.transform = 'translateY(0)';
        });

        const cleanup = (ev) => {
          if (ev && ev.propertyName !== 'transform') return;
          card.style.transition = '';
          card.style.transform = '';
          card.removeEventListener('transitionend', cleanup);
        };
        card.addEventListener('transitionend', cleanup);
      });
    }

    /* Ocultar botones al hacer scroll: menÃº y asignaturas */
    function initScrollHideUI() {
      const menu = document.getElementById('menu-screen');
      const subjects = document.getElementById('subjects-screen');
      // addSemesterBtn might be null now
      const addSemester = document.getElementById('add-semester-btn');
      const addSubject = document.getElementById('add-btn');
      const toolsWrapper = document.querySelector('.tools-menu-wrapper');

      let lastMenuScroll = 0;
      let lastSubjectsScroll = 0;

      if (menu) {
        menu.addEventListener('scroll', () => {
          const y = menu.scrollTop;
          const scrollingDown = y > lastMenuScroll + 3;
          lastMenuScroll = y;
          // Fab removal logic was here
        }, { passive: true });
      }

      if (subjects) {
        subjects.addEventListener('scroll', () => {
          const y = subjects.scrollTop;
          const scrollingDown = y > lastSubjectsScroll + 3;
          lastSubjectsScroll = y;
          if (scrollingDown) {
            addSubject && addSubject.classList.add('hide');
            toolsWrapper && toolsWrapper.classList.add('hide');
          } else {
            addSubject && addSubject.classList.remove('hide');
            toolsWrapper && toolsWrapper.classList.remove('hide');
          }
        }, { passive: true });
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.card.show-controls').forEach(card => card.classList.remove('show-controls'));
      }
    });

    /* -------------------------
       Firebase Integration (Cloud Sync)
       ------------------------- */

    const firebaseConfig = {
      apiKey: "AIzaSyCJHgBQwesEY2m8F76UKZy1003xHg_BGkY",
      authDomain: "studyboard-262ae.firebaseapp.com",
      projectId: "studyboard-262ae",
      storageBucket: "studyboard-262ae.firebasestorage.app",
      messagingSenderId: "48243887816",
      appId: "1:48243887816:web:87ab54f94ca9be90851ffd",
      measurementId: "G-Q12YH4ZL0P"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let isSyncing = false;
    let syncTimeout = null;
    let syncCode = null; // CÃ³digo de 6 dÃ­gitos para sincronizaciÃ³n

    const firebaseBtn = document.getElementById('firebase-btn');
    const syncIndicator = document.getElementById('sync-indicator');
    const syncCodeModal = document.getElementById('sync-code-modal');
    const syncCodeContent = document.getElementById('sync-code-content');

    // Mostrar indicador de sincronizaciÃ³n
    function showSyncIndicator(text, type = 'syncing') {
      const syncText = syncIndicator.querySelector('.sync-text');
      syncText.textContent = text;
      syncIndicator.className = 'sync-indicator show';

      if (type === 'success') {
        syncIndicator.classList.add('success');
        syncIndicator.querySelector('.sync-spinner').style.display = 'none';
      } else if (type === 'error') {
        syncIndicator.classList.add('error');
        syncIndicator.querySelector('.sync-spinner').style.display = 'none';
      } else {
        syncIndicator.querySelector('.sync-spinner').style.display = 'block';
      }

      syncIndicator.style.display = 'flex';

      if (type !== 'syncing') {
        setTimeout(() => {
          syncIndicator.classList.remove('show');
          setTimeout(() => {
            syncIndicator.style.display = 'none';
          }, 400); // Esperar a que termine la animaciÃ³n
        }, 3000);
      }
    }

    // Actualizar estado visual del botÃ³n
    function updateFirebaseButtonState(connected) {
      if (connected) {
        firebaseBtn.classList.add('connected');
        firebaseBtn.title = 'Conectado - Click para ver cÃ³digo';
      } else {
        firebaseBtn.classList.remove('connected');
        firebaseBtn.title = 'Sincronizar con la nube';
      }
    }

    // Generar cÃ³digo de 6 dÃ­gitos
    function generateSyncCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Mostrar modal con opciones de sincronizaciÃ³n
    function showSyncModal() {
      const savedCode = localStorage.getItem('syncCode');

      if (savedCode) {
        // Ya tiene cÃ³digo, mostrar opciones
        syncCodeContent.innerHTML = `
      <div style="text-align: center; padding: 20px 0;">
        <h3 style="margin: 0 0 10px 0; color: var(--text);">Tu cÃ³digo de sincronizaciÃ³n</h3>
        <div id="sync-code-display" style="font-size: 48px; font-weight: 700; color: #4285f4; letter-spacing: 8px; margin: 20px 0; cursor: pointer; user-select: none; transition: transform 0.2s ease;" title="Doble click para copiar">
          ${savedCode}
        </div>
        <p style="color: var(--text); opacity: 0.7; font-size: 14px; margin: 20px 0;">
          Usa este cÃ³digo en otros dispositivos para sincronizar tus datos<br>
          <small style="opacity: 0.6;">(Doble click en el cÃ³digo para copiar)</small>
        </p>
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
          <button onclick="copySyncCode('${savedCode}')" style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: transform 0.2s ease, box-shadow 0.2s ease; flex: 1; min-width: 140px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(66,133,244,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
            ğŸ“‹ Copiar cÃ³digo
          </button>
          <button onclick="disconnectSync()" style="background: #ef4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: transform 0.2s ease, box-shadow 0.2s ease; flex: 1; min-width: 140px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239,68,68,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
            ğŸ”Œ Desconectar
          </button>
        </div>
        <button onclick="closeSyncModal()" style="background: var(--card-bg); color: var(--text); border: 1px solid rgba(0,0,0,0.1); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; margin-top: 15px; display: block; width: 100%; transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
          Cerrar
        </button>
      </div>
    `;

        // Agregar event listener para doble click en el cÃ³digo
        setTimeout(() => {
          const codeDisplay = document.getElementById('sync-code-display');
          if (codeDisplay) {
            let clickCount = 0;
            let clickTimer = null;

            codeDisplay.addEventListener('click', (e) => {
              e.preventDefault();
              clickCount++;

              if (clickCount === 1) {
                clickTimer = setTimeout(() => {
                  clickCount = 0;
                }, 400);
              } else if (clickCount === 2) {
                clearTimeout(clickTimer);
                clickCount = 0;
                copySyncCode(savedCode);
                // Efecto visual
                codeDisplay.style.transform = 'scale(1.1)';
                setTimeout(() => {
                  codeDisplay.style.transform = '';
                }, 200);
              }
            });

            // TambiÃ©n soportar dblclick nativo
            codeDisplay.addEventListener('dblclick', (e) => {
              e.preventDefault();
              copySyncCode(savedCode);
              codeDisplay.style.transform = 'scale(1.1)';
              setTimeout(() => {
                codeDisplay.style.transform = '';
              }, 200);
            });
          }
        }, 100);
      } else {
        // No tiene cÃ³digo, ofrecer crear o introducir
        syncCodeContent.innerHTML = `
      <div style="padding: 20px 0;">
        <h3 style="margin: 0 0 10px 0; color: var(--text); text-align: center;">Â¿CÃ³mo quieres sincronizar?</h3>
        
        <div style="background: var(--card-bg); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 20px; margin: 20px 0;">
          <h4 style="margin: 0 0 10px 0; color: var(--text); font-size: 16px;">ğŸ“± Primer dispositivo</h4>
          <p style="color: var(--text); opacity: 0.7; font-size: 14px; margin: 0 0 15px 0;">
            Crea un cÃ³digo nuevo para sincronizar tus datos
          </p>
          <button onclick="createNewSync()" style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; width: 100%; transition: transform 0.2s ease, box-shadow 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(66,133,244,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
            âœ¨ Crear cÃ³digo nuevo
          </button>
        </div>
        
        <div style="background: var(--card-bg); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 20px; margin: 20px 0;">
          <h4 style="margin: 0 0 10px 0; color: var(--text); font-size: 16px;">ğŸ”— Otro dispositivo</h4>
          <p style="color: var(--text); opacity: 0.7; font-size: 14px; margin: 0 0 15px 0;">
            Introduce el cÃ³digo de 6 dÃ­gitos de tu otro dispositivo
          </p>
          <input type="text" id="sync-code-input" placeholder="000000" maxlength="6" style="width: 100%; padding: 14px; border-radius: 8px; border: 2px solid var(--input-bg); background: var(--bg); color: var(--text); font-size: 24px; text-align: center; letter-spacing: 8px; font-weight: 700; margin-bottom: 15px; font-family: 'Poppins', sans-serif; box-sizing: border-box;" />
          <button onclick="connectWithCode()" style="background: #34a853; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; width: 100%; transition: transform 0.2s ease, box-shadow 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(52,168,83,0.3)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
            ğŸ”„ Conectar
          </button>
        </div>
        
        <button onclick="closeSyncModal()" style="background: var(--card-bg); color: var(--text); border: 1px solid rgba(0,0,0,0.1); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; margin-top: 10px; width: 100%; transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
          Cancelar
        </button>
      </div>
    `;
      }

      syncCodeModal.style.display = 'flex';
      setTimeout(() => {
        syncCodeModal.classList.add('show');
      }, 10);
    }

    // Cerrar modal
    function closeSyncModal() {
      syncCodeModal.classList.remove('show');
      setTimeout(() => {
        syncCodeModal.style.display = 'none';
      }, 300);
    }

    // Crear nueva sincronizaciÃ³n
    async function createNewSync() {
      const code = generateSyncCode();
      syncCode = code;
      localStorage.setItem('syncCode', code);

      try {
        await signInAnonymously();
        // Guardar datos locales actuales en Firebase
        await saveToFirebase();
        closeSyncModal();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Conectar con cÃ³digo existente
    async function connectWithCode() {
      const input = document.getElementById('sync-code-input');
      const code = input.value.trim();

      if (code.length !== 6 || !/^\d+$/.test(code)) {
        alert('Por favor, introduce un cÃ³digo de 6 dÃ­gitos vÃ¡lido');
        return;
      }

      syncCode = code;
      localStorage.setItem('syncCode', code);

      try {
        await signInAnonymously();
        // Los datos se cargan automÃ¡ticamente dentro de signInAnonymously
        closeSyncModal();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Copiar cÃ³digo
    function copySyncCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        showSyncIndicator('CÃ³digo copiado', 'success');
      }).catch(() => {
        // Fallback para navegadores antiguos
        const textarea = document.createElement('textarea');
        textarea.value = code;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showSyncIndicator('CÃ³digo copiado', 'success');
      });
    }

    // Desconectar sincronizaciÃ³n
    async function disconnectSync() {
      if (confirm('Â¿Desconectar sincronizaciÃ³n? Los datos locales se mantendrÃ¡n, pero no se sincronizarÃ¡n mÃ¡s.')) {
        try {
          await auth.signOut();
          currentUser = null;
          syncCode = null;
          localStorage.removeItem('syncCode');
          localStorage.removeItem('firebaseUserId');
          updateFirebaseButtonState(false);
          closeSyncModal();
          showSyncIndicator('Desconectado', 'success');
        } catch (error) {
          console.error('Error al desconectar:', error);
        }
      }
    }

    // AutenticaciÃ³n anÃ³nima
    async function signInAnonymously() {
      try {
        showSyncIndicator('Conectando...');

        // Usar el cÃ³digo de sincronizaciÃ³n como ID
        if (!syncCode) {
          syncCode = localStorage.getItem('syncCode') || generateSyncCode();
          localStorage.setItem('syncCode', syncCode);
        }

        const result = await auth.signInAnonymously();
        currentUser = result.user;
        updateFirebaseButtonState(true);
        showSyncIndicator('Conectado correctamente', 'success');
        await loadFromFirebase();
        return true;
      } catch (error) {
        console.error('Error al conectar:', error);

        // Mensajes de error mÃ¡s especÃ­ficos
        if (error.code === 'auth/operation-not-allowed') {
          showSyncIndicator('Habilita autenticaciÃ³n anÃ³nima en Firebase Console', 'error');
          alert('ERROR: Debes habilitar la autenticaciÃ³n anÃ³nima en Firebase Console.\n\n1. Ve a: Authentication â†’ Sign-in method\n2. Click en "Anonymous"\n3. Activa el toggle\n4. Guarda');
        } else if (error.code === 'auth/network-request-failed') {
          showSyncIndicator('Sin conexiÃ³n a internet', 'error');
        } else {
          showSyncIndicator('Error: ' + (error.message || 'Desconocido'), 'error');
        }
        return false;
      }
    }

    // Cerrar sesiÃ³n
    async function signOut() {
      if (confirm('Â¿Desconectar sincronizaciÃ³n? Los datos locales se mantendrÃ¡n.')) {
        try {
          await auth.signOut();
          currentUser = null;
          localStorage.removeItem('firebaseUserId');
          updateFirebaseButtonState(false);
          showSyncIndicator('Desconectado', 'success');
        } catch (error) {
          console.error('Error al desconectar:', error);
        }
      }
    }

    // Cargar datos desde Firebase
    async function loadFromFirebase() {
      if (!currentUser || isSyncing || !syncCode) return;

      isSyncing = true;
      showSyncIndicator('Cargando desde la nube...');

      try {
        // Usar el cÃ³digo de sincronizaciÃ³n como clave del documento
        const doc = await db.collection('sync').doc(syncCode).get();

        if (doc.exists) {
          const data = doc.data();
          if (data.cuatrimestres) {
            localStorage.setItem('cuatrimestres', JSON.stringify(data.cuatrimestres));
            renderSemesters();
          }
          if (data.exams) {
            localStorage.setItem('exams', JSON.stringify(data.exams));
            // Actualizar avisos si estamos en el menÃº
            if (menuScreen.classList.contains('active')) {
              checkUpcomingExams();
            }
          }
          showSyncIndicator('Datos cargados âœ“', 'success');
        } else {
          showSyncIndicator('No hay datos en la nube', 'success');
        }
      } catch (error) {
        console.error('Error cargando desde Firebase:', error);
        showSyncIndicator('Error al cargar datos', 'error');
      } finally {
        isSyncing = false;
      }
    }

    // Guardar datos en Firebase
    async function saveToFirebase() {
      if (!currentUser || isSyncing || !syncCode) return;

      isSyncing = true;
      showSyncIndicator('Guardando en la nube...');

      try {
        const data = {
          cuatrimestres: obtenerCuatrimestres(),
          exams: JSON.parse(localStorage.getItem('exams') || '[]'),
          lastSync: firebase.firestore.FieldValue.serverTimestamp(),
          version: '1.0'
        };

        // Usar el cÃ³digo de sincronizaciÃ³n como clave del documento
        await db.collection('sync').doc(syncCode).set(data);
        showSyncIndicator('Guardado en la nube âœ“', 'success');
      } catch (error) {
        console.error('Error guardando en Firebase:', error);
        showSyncIndicator('Error al guardar', 'error');
      } finally {
        isSyncing = false;
      }
    }

    // SincronizaciÃ³n automÃ¡tica inmediata
    function scheduleSyncToFirebase() {
      if (!currentUser) return;
      saveToFirebase();
    }

    // Event listener del botÃ³n Firebase
    firebaseBtn.addEventListener('click', () => {
      if (currentUser) {
        showSyncModal();
      } else {
        showSyncModal();
      }
    });

    // Modificar guardar() para sincronizar automÃ¡ticamente
    const originalGuardar = guardar;
    guardar = function () {
      originalGuardar();
      scheduleSyncToFirebase();
    };

    // Modificar guardarCuatrimestres para sincronizar
    const originalGuardarCuatrimestres = guardarCuatrimestres;
    guardarCuatrimestres = function () {
      originalGuardarCuatrimestres();
      scheduleSyncToFirebase();
    };

    // Observador de estado de autenticaciÃ³n
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        updateFirebaseButtonState(true);
      } else {
        currentUser = null;
        updateFirebaseButtonState(false);
      }
    });

    // Cargar datos automÃ¡ticamente al iniciar si hay cÃ³digo guardado
    window.addEventListener('load', async () => {
      const savedCode = localStorage.getItem('syncCode');
      if (savedCode && !currentUser) {
        syncCode = savedCode;
        await signInAnonymously();
        // Los datos ya se cargan dentro de signInAnonymously
      }
    });

    /* -------------------------
       CALCULADORA DE NOTAS
       ------------------------- */
    const calculatorModal = document.getElementById('calculator-modal');
    const calculatorBtn = document.getElementById('calculator-btn');
    const dashboardModal = document.getElementById('dashboard-modal');
    const dashboardBtn = document.getElementById('dashboard-btn');
    const toolsMenuToggle = document.getElementById('tools-menu-toggle');
    const toolsMenu = document.getElementById('tools-menu');
    const toolsMenuWrapper = document.querySelector('.tools-menu-wrapper');

    // Toggle menÃº FAB
    toolsMenuToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      toolsMenu.classList.toggle('show');
      toolsMenuWrapper.classList.toggle('active');
    });

    // Cerrar menÃº al hacer click fuera
    document.addEventListener('click', (e) => {
      if (!toolsMenuWrapper.contains(e.target)) {
        toolsMenu.classList.remove('show');
        toolsMenuWrapper.classList.remove('active');
      }
    });

    // Cerrar menÃº al hacer click en un botÃ³n
    toolsMenu.querySelectorAll('.fab-option').forEach(btn => {
      btn.addEventListener('click', () => {
        toolsMenu.classList.remove('show');
        toolsMenuWrapper.classList.remove('active');
      });
    });

    // Abrir calculadora
    calculatorBtn.addEventListener('click', () => {
      calculatorModal.style.display = 'flex';
      setTimeout(() => calculatorModal.classList.add('show'), 10);
    });

    // Cerrar calculadora
    function closeCalculatorModal() {
      calculatorModal.classList.remove('show');
      setTimeout(() => {
        calculatorModal.style.display = 'none';
        document.getElementById('calc-result').style.display = 'none';
        document.getElementById('calc-current-grade').value = '';
        document.getElementById('calc-percentage-done').value = '';
        document.getElementById('calc-target-grade').value = '5.0';
      }, 300);
    }

    // Calcular nota necesaria
    function calculateNeededGrade() {
      const currentGrade = parseNumber(document.getElementById('calc-current-grade').value);
      const percentageDone = parseNumber(document.getElementById('calc-percentage-done').value);
      const targetGrade = parseNumber(document.getElementById('calc-target-grade').value) || 5.0;

      const resultDiv = document.getElementById('calc-result');

      if (percentageDone <= 0 || percentageDone > 100) {
        resultDiv.innerHTML = '<p class="calc-error">âš ï¸ El porcentaje debe estar entre 1 y 100</p>';
        resultDiv.style.display = 'block';
        return;
      }

      if (percentageDone >= 100) {
        resultDiv.innerHTML = `<p class="calc-info">âœ… Ya completaste el 100% del curso con nota <strong>${currentGrade.toFixed(2)}</strong></p>`;
        resultDiv.style.display = 'block';
        return;
      }

      const percentageRemaining = 100 - percentageDone;
      const neededGrade = (targetGrade * 100 - currentGrade * percentageDone) / percentageRemaining;

      resultDiv.style.display = 'block';

      if (neededGrade > 10) {
        resultDiv.innerHTML = `
      <p class="calc-error">ğŸ˜° Â¡Imposible alcanzar ${targetGrade}!</p>
      <p>NecesitarÃ­as un <strong>${neededGrade.toFixed(2)}</strong> en el ${percentageRemaining}% restante.</p>
      <p class="calc-tip">ğŸ’¡ Ajusta tu objetivo o esfuÃ©rzate por subir la nota actual.</p>
    `;
      } else if (neededGrade < 0) {
        resultDiv.innerHTML = `
      <p class="calc-success">ğŸ‰ Â¡Ya superaste tu objetivo!</p>
      <p>Tu nota actual <strong>${currentGrade.toFixed(2)}</strong> ya es mayor que ${targetGrade}</p>
    `;
      } else {
        let emoji = 'ğŸ“';
        let className = 'calc-info';
        if (neededGrade >= 9) {
          emoji = 'ğŸ”¥';
          className = 'calc-warning';
        } else if (neededGrade >= 7) {
          emoji = 'ğŸ’ª';
          className = 'calc-warning';
        } else if (neededGrade >= 5) {
          emoji = 'âœ…';
          className = 'calc-success';
        } else {
          emoji = 'ğŸ˜';
          className = 'calc-success';
        }

        resultDiv.innerHTML = `
      <p class="${className}">${emoji} Necesitas un <strong>${neededGrade.toFixed(2)}</strong></p>
      <p>en el <strong>${percentageRemaining}%</strong> restante para alcanzar ${targetGrade}</p>
    `;
      }
    }

    /* -------------------------
       DASHBOARD Y GRÃFICOS
       ------------------------- */

    // Abrir dashboard
    dashboardBtn.addEventListener('click', () => {
      dashboardModal.style.display = 'flex';
      setTimeout(() => {
        dashboardModal.classList.add('show');
        updateDashboard();
      }, 10);
    });

    // Tabs del dashboard
    document.querySelectorAll('.dashboard-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;

        // Cambiar tab activo
        document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Cambiar contenido activo
        document.querySelectorAll('.dashboard-tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-content="${targetTab}"]`).classList.add('active');
      });
    });

    // Cerrar dashboard
    function closeDashboardModal() {
      dashboardModal.classList.remove('show');
      setTimeout(() => dashboardModal.style.display = 'none', 300);
    }

    // Actualizar dashboard
    function updateDashboard() {
      if (!currentSemester) return;

      // Obtener datos desde las tarjetas del DOM
      const cards = Array.from(document.querySelectorAll('.card:not(.drag-preview)'));
      const subjects = cards.map(card => {
        const name = card.querySelector('.titulo').textContent;
        const color = card.style.background;
        const gradeText = calcularNotaAsignatura(card);
        const grade = gradeText !== '-' ? parseFloat(gradeText) : 0;
        return { name, color, grade };
      });

      const gradesOnly = subjects
        .map(s => s.grade)
        .filter(g => g > 0);

      // EstadÃ­sticas bÃ¡sicas
      const average = gradesOnly.length > 0
        ? (gradesOnly.reduce((a, b) => a + b, 0) / gradesOnly.length).toFixed(2)
        : '-';
      const passed = subjects.filter(s => s.grade >= 5).length;
      const failed = subjects.filter(s => s.grade > 0 && s.grade < 5).length;

      // Calcular ECTS aprobados (6 ECTS por asignatura aprobada)
      const totalEcts = passed * 6;

      document.getElementById('dash-average').textContent = average;
      document.getElementById('dash-passed').textContent = passed;
      document.getElementById('dash-failed').textContent = failed;
      document.getElementById('dash-ects').textContent = totalEcts;

      // GrÃ¡fico de distribuciÃ³n
      drawGradesChart(gradesOnly);

      // Ranking de asignaturas
      const ranking = subjects
        .filter(s => s.grade > 0)
        .sort((a, b) => b.grade - a.grade)
        .map((s, i) => {
          const grade = s.grade;
          let emoji = 'ğŸ“•';
          if (grade >= 9) emoji = 'ğŸ†';
          else if (grade >= 7) emoji = 'ğŸ“—';
          else if (grade >= 5) emoji = 'ğŸ“˜';

          return `
        <div class="ranking-item" style="background: ${s.color}; opacity: 0.9;">
          <span class="ranking-pos">${i + 1}</span>
          <span class="ranking-name">${s.name}</span>
          <span class="ranking-grade">${emoji} ${grade.toFixed(2)}</span>
        </div>
      `;
        }).join('');

      document.getElementById('subjects-ranking').innerHTML = ranking || '<p style="text-align:center; color:#94a3b8;">No hay notas registradas</p>';
    }

    // Dibujar grÃ¡fico con barras horizontales
    function drawGradesChart(grades) {
      const container = document.getElementById('grades-chart-bars');

      if (grades.length === 0) {
        container.innerHTML = '<p class="no-data">ğŸ“„ No hay datos para mostrar</p>';
        return;
      }

      // DistribuciÃ³n por rangos
      const ranges = [
        { label: 'Suspensos', emoji: 'ğŸ“•', range: '0-5', min: 0, max: 5, color: '#ef4444', count: 0 },
        { label: 'Aprobados', emoji: 'ğŸ“˜', range: '5-7', min: 5, max: 7, color: '#f59e0b', count: 0 },
        { label: 'Notables', emoji: 'ğŸ“—', range: '7-9', min: 7, max: 9, color: '#3b82f6', count: 0 },
        { label: 'Sobresalientes', emoji: 'ğŸ†', range: '9-10', min: 9, max: 10, color: '#10b981', count: 0 }
      ];

      grades.forEach(g => {
        if (g < 5) ranges[0].count++;
        else if (g < 7) ranges[1].count++;
        else if (g < 9) ranges[2].count++;
        else ranges[3].count++;
      });

      const total = grades.length;

      container.innerHTML = ranges.map((range, i) => {
        const percentage = total > 0 ? Math.round((range.count / total) * 100) : 0;
        return `
      <div class="chart-bar-item" style="animation-delay: ${i * 0.1}s">
        <div class="chart-bar-header">
          <span class="chart-bar-label">${range.emoji} ${range.label}</span>
          <span class="chart-bar-value">${range.count} (${percentage}%)</span>
        </div>
        <div class="chart-bar-track">
          <div class="chart-bar-fill" style="width: ${percentage}%; background: ${range.color};"></div>
        </div>
      </div>
    `;
      }).join('');
    }

    /* -------------------------
       RECOMENDACIONES IA
       ------------------------- */

    function updateAIRecommendation() {
      if (!currentSemester) return;

      const aiDiv = document.getElementById('ai-recommendation');
      const aiText = document.getElementById('ai-recommendation-text');
      const cards = Array.from(document.querySelectorAll('.card:not(.drag-preview)'));

      if (cards.length === 0) {
        aiDiv.style.display = 'none';
        return;
      }

      // Analizar asignaturas con predicciones MEJORADAS
      const subjects = cards.map(card => {
        const name = card.querySelector('.titulo').textContent;
        const tests = card._tests || [];
        const testGrades = tests.map(t => parseFloat(t.nota)).filter(n => !isNaN(n) && n > 0);
        const testWeights = tests.map(t => parseFloat(t.ponderacion)).filter(n => !isNaN(n) && n > 0);

        if (testGrades.length === 0) {
          return {
            name,
            currentGrade: 0,
            predictedGrade: null,
            trend: 'sin-datos',
            confidence: 0,
            analysis: 'Sin datos suficientes'
          };
        }

        // Nota acumulada actual y porcentaje evaluado
        const currentGradeText = calcularNotaAsignatura(card);
        const currentGrade = currentGradeText !== '-' ? parseFloat(currentGradeText) : 0;

        let totalWeight = 0;
        let weightedSum = 0;
        tests.forEach((t, i) => {
          if (!isNaN(t.nota) && !isNaN(t.ponderacion) && t.nota > 0) {
            totalWeight += parseFloat(t.ponderacion);
            weightedSum += parseFloat(t.nota) * parseFloat(t.ponderacion) / 100;
          }
        });

        const evaluatedPercent = Math.min(100, totalWeight);
        const remainingPercent = 100 - evaluatedPercent;

        // ============ PREDICCIÃ“N AVANZADA ============

        let predictedGrade = currentGrade;
        let confidence = 0;
        let trend = 'estable';
        let analysis = '';

        if (testGrades.length === 1) {
          // Solo 1 nota: predecir que se mantendrÃ¡ similar
          predictedGrade = testGrades[0];
          confidence = 40; // Baja confianza con 1 sola nota
          analysis = `Con 1 sola nota (${testGrades[0].toFixed(1)}), se asume rendimiento constante.`;

        } else if (testGrades.length >= 2) {
          // PASO 1: AnÃ¡lisis estadÃ­stico
          const average = testGrades.reduce((sum, g) => sum + g, 0) / testGrades.length;
          const variance = testGrades.reduce((sum, g) => sum + Math.pow(g - average, 2), 0) / testGrades.length;
          const stdDev = Math.sqrt(variance);

          // PASO 2: AnÃ¡lisis de tendencia temporal
          const firstHalf = testGrades.slice(0, Math.ceil(testGrades.length / 2));
          const secondHalf = testGrades.slice(Math.ceil(testGrades.length / 2));
          const avgFirst = firstHalf.reduce((sum, g) => sum + g, 0) / firstHalf.length;
          const avgSecond = secondHalf.reduce((sum, g) => sum + g, 0) / secondHalf.length;
          const trendDiff = avgSecond - avgFirst;

          // PASO 3: AnÃ¡lisis de momentum (Ãºltimas 2 notas)
          const lastTwo = testGrades.slice(-2);
          const recentAvg = lastTwo.reduce((sum, g) => sum + g, 0) / lastTwo.length;
          const momentum = lastTwo[1] - lastTwo[0];

          // PASO 4: Determinar tendencia
          if (trendDiff > 0.8) {
            trend = 'subiendo-fuerte';
            analysis = `ğŸ“ˆ Mejora clara: +${trendDiff.toFixed(1)} puntos entre primera y segunda mitad.`;
          } else if (trendDiff > 0.3) {
            trend = 'subiendo';
            analysis = `â†—ï¸ Tendencia positiva: +${trendDiff.toFixed(1)} puntos de mejora.`;
          } else if (trendDiff < -0.8) {
            trend = 'bajando-fuerte';
            analysis = `ğŸ“‰ CaÃ­da preocupante: ${trendDiff.toFixed(1)} puntos de descenso.`;
          } else if (trendDiff < -0.3) {
            trend = 'bajando';
            analysis = `â†˜ï¸ Tendencia negativa: ${trendDiff.toFixed(1)} puntos de descenso.`;
          } else {
            trend = 'estable';
            analysis = `â¡ï¸ Rendimiento estable (variaciÃ³n: ${trendDiff.toFixed(1)}).`;
          }

          // PASO 5: Calcular confianza
          // Factores:
          // - MÃ¡s notas = mÃ¡s confianza (mÃ¡x 40%)
          // - Menor desviaciÃ³n estÃ¡ndar = mÃ¡s confianza (mÃ¡x 30%)
          // - MÃ¡s % evaluado = mÃ¡s confianza (mÃ¡x 30%)

          const dataConfidence = Math.min(40, testGrades.length * 8); // 8% por cada nota
          const consistencyConfidence = Math.min(30, 30 * (1 - Math.min(1, stdDev / 3))); // Penalizar alta variabilidad
          const coverageConfidence = Math.min(30, evaluatedPercent * 0.3); // 0.3% por cada 1% evaluado

          confidence = Math.round(dataConfidence + consistencyConfidence + coverageConfidence);

          // PASO 6: PredicciÃ³n segÃºn escenario
          if (evaluatedPercent >= 100) {
            // Todo evaluado: nota final es la actual
            predictedGrade = currentGrade;
            analysis += ` EvaluaciÃ³n completa (100%).`;
          } else if (evaluatedPercent >= 70) {
            // >70% evaluado: alta certeza, leve ajuste por tendencia
            if (trend.includes('subiendo')) {
              predictedGrade = currentGrade + Math.min(0.5, trendDiff * 0.3);
            } else if (trend.includes('bajando')) {
              predictedGrade = currentGrade + Math.max(-0.5, trendDiff * 0.3);
            } else {
              predictedGrade = currentGrade;
            }
            analysis += ` ${evaluatedPercent.toFixed(0)}% evaluado, predicciÃ³n ajustada por tendencia.`;
          } else if (evaluatedPercent >= 40) {
            // 40-70% evaluado: balance entre promedio histÃ³rico y tendencia
            const baselinePrediction = average;
            const trendAdjustment = trendDiff * 0.4;
            predictedGrade = baselinePrediction + trendAdjustment;
            analysis += ` ${evaluatedPercent.toFixed(0)}% evaluado. PredicciÃ³n: promedio + ajuste tendencial.`;
          } else {
            // <40% evaluado: dar mÃ¡s peso a Ãºltimas notas (momentum)
            predictedGrade = recentAvg + momentum * 0.3;
            confidence -= 15; // Penalizar confianza por poca cobertura
            analysis += ` Solo ${evaluatedPercent.toFixed(0)}% evaluado. Alta incertidumbre, se usa momentum reciente.`;
          }

          // PASO 7: Calcular lo que necesita en lo que falta para aprobar/notable
          if (remainingPercent > 0) {
            const neededFor5 = (5.0 - weightedSum) * 100 / remainingPercent;
            const neededFor7 = (7.0 - weightedSum) * 100 / remainingPercent;

            if (neededFor5 > 10) {
              analysis += ` âš ï¸ Imposible aprobar (necesitarÃ­a >${neededFor5.toFixed(1)}).`;
              predictedGrade = Math.max(0, weightedSum + (remainingPercent / 100) * 5); // Asumir 5 en resto
            } else if (neededFor5 > 7) {
              analysis += ` ğŸ”¥ DifÃ­cil aprobar (necesita ${neededFor5.toFixed(1)} en lo que falta).`;
            } else if (neededFor5 <= 5) {
              analysis += ` âœ… Aprobado casi asegurado (solo necesita ${neededFor5.toFixed(1)}).`;
            }
          }
        }

        // Limitar a rango vÃ¡lido
        predictedGrade = Math.max(0, Math.min(10, predictedGrade));

        return {
          name,
          currentGrade,
          predictedGrade,
          trend,
          confidence,
          testCount: testGrades.length,
          evaluatedPercent,
          analysis
        };
      });

      // Filtrar asignaturas con datos
      const withData = subjects.filter(s => s.predictedGrade !== null);

      if (withData.length === 0) {
        aiText.textContent = 'âœ¨ AÃºn no hay notas registradas. Â¡Empieza con buen pie este cuatrimestre!';
        aiDiv.style.display = 'flex';
        return;
      }

      // ============ GENERACIÃ“N DE RECOMENDACIÃ“N ============

      // Identificar casos crÃ­ticos
      const criticalRisk = withData.filter(s => s.predictedGrade < 4.5);
      const atRisk = withData.filter(s => s.predictedGrade >= 4.5 && s.predictedGrade < 5);
      const needBoost = withData.filter(s => s.predictedGrade >= 5 && s.predictedGrade < 7 && s.trend.includes('bajando'));
      const declining = withData.filter(s => s.trend.includes('bajando-fuerte'));
      const improving = withData.filter(s => s.trend.includes('subiendo-fuerte'));
      const excellent = withData.filter(s => s.predictedGrade >= 9);

      let recommendation = '';
      let emoji = 'ğŸ¤–';

      // Prioridad: crÃ­tico > riesgo > mejora > excelencia
      if (criticalRisk.length > 0) {
        const crit = criticalRisk[0];
        emoji = 'ğŸš¨';
        recommendation = `URGENTE: ${crit.name} (prev: ${crit.predictedGrade.toFixed(1)}, conf: ${crit.confidence}%). ${crit.analysis}`;
      } else if (atRisk.length > 0) {
        const risk = atRisk[0];
        emoji = 'âš ï¸';
        recommendation = `Riesgo de suspenso: ${risk.name} (prev: ${risk.predictedGrade.toFixed(1)}, conf: ${risk.confidence}%). ${risk.analysis}`;
      } else if (declining.length > 0) {
        const dec = declining[0];
        emoji = 'ğŸ“‰';
        recommendation = `Alerta de caÃ­da: ${dec.name} (prev: ${dec.predictedGrade.toFixed(1)}, conf: ${dec.confidence}%). ${dec.analysis}`;
      } else if (needBoost.length > 0) {
        const boost = needBoost[0];
        emoji = 'âš¡';
        recommendation = `Refuerza ${boost.name} (prev: ${boost.predictedGrade.toFixed(1)}, conf: ${boost.confidence}%). ${boost.analysis}`;
      } else if (improving.length > 0) {
        const imp = improving[0];
        emoji = 'ğŸš€';
        recommendation = `Â¡Gran progreso! ${imp.name} (prev: ${imp.predictedGrade.toFixed(1)}, conf: ${imp.confidence}%). ${imp.analysis}`;
      } else if (excellent.length === withData.length) {
        emoji = 'ğŸ†';
        const avgConf = Math.round(excellent.reduce((sum, s) => sum + s.confidence, 0) / excellent.length);
        recommendation = `Sobresaliente total (conf promedio: ${avgConf}%). Â¡Todas hacia la excelencia!`;
      } else {
        const avgPredicted = withData.reduce((sum, s) => sum + s.predictedGrade, 0) / withData.length;
        const avgConf = Math.round(withData.reduce((sum, s) => sum + s.confidence, 0) / withData.length);

        if (avgPredicted >= 8) {
          emoji = 'ğŸŒŸ';
          recommendation = `PrevisiÃ³n muy positiva: ${avgPredicted.toFixed(1)} (conf: ${avgConf}%). Â¡Vas camino del notable alto!`;
        } else if (avgPredicted >= 7) {
          emoji = 'ğŸ’ª';
          recommendation = `Buen rumbo: ${avgPredicted.toFixed(1)} (conf: ${avgConf}%). Con constancia alcanzarÃ¡s la excelencia.`;
        } else if (avgPredicted >= 6) {
          emoji = 'ğŸ“š';
          recommendation = `Aprobando todo: ${avgPredicted.toFixed(1)} (conf: ${avgConf}%). Margen de mejora detectado.`;
        } else {
          emoji = 'ğŸ”';
          recommendation = `PrevisiÃ³n: ${avgPredicted.toFixed(1)} (conf: ${avgConf}%). Revisa estrategia de estudio.`;
        }
      }

      aiText.textContent = `${emoji} ${recommendation}`;
      aiDiv.style.display = 'flex';
    }

    /* -------------------------
       EXPORTAR PDF
       ------------------------- */

    const exportModal = document.getElementById('export-modal');
    const exportPdfBtn = document.getElementById('export-pdf-btn');

    // Abrir modal de exportaciÃ³n
    exportPdfBtn.addEventListener('click', () => {
      // Rellenar tÃ­tulo por defecto
      const titleInput = document.getElementById('export-title-text');
      const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long' });
      titleInput.value = `Informe AcadÃ©mico - ${currentSemester ? currentSemester.nombre : currentDate}`;

      exportModal.style.display = 'flex';
      setTimeout(() => exportModal.classList.add('show'), 10);
    });

    function closeExportModal() {
      exportModal.classList.remove('show');
      setTimeout(() => exportModal.style.display = 'none', 300);
    }

    // Cerrar modal al hacer clic fuera
    exportModal.addEventListener('click', (e) => {
      if (e.target === exportModal) closeExportModal();
    });

    /* -------------------------
       MODAL EXÃMENES
       ------------------------- */
    const examsBtn = document.getElementById('exams-btn');
    const examsModal = document.getElementById('exams-modal');
    const addExamForm = document.getElementById('add-exam-form');
    const examsList = document.getElementById('exams-list');
    const noExamsMessage = document.getElementById('no-exams-message');

    // Abrir modal de exÃ¡menes
    examsBtn.addEventListener('click', () => {
      populateSubjectSelect();
      renderExams();
      examsModal.style.display = 'flex';
      requestAnimationFrame(() => examsModal.classList.add('show'));
      document.body.style.overflow = 'hidden';
      // Agregar al historial para manejo del botÃ³n atrÃ¡s
      history.pushState({ modal: 'exams' }, '', '#exams');
    });

    function closeExamsModal() {
      examsModal.classList.remove('show');
      setTimeout(() => {
        examsModal.style.display = 'none';
        closeAddExamForm();
      }, 260);
      document.body.style.overflow = '';
      // Limpiar historial si estamos en el modal (sin navegar)
      if (window.location.hash === '#exams') {
        // Usar replaceState en vez de back() para no activar navegaciÃ³n
        const currentHash = subjectsScreen.classList.contains('active') ? '#subjects' : '#menu';
        history.replaceState(null, '', currentHash);
      }
    }

    // Cerrar modal al hacer clic fuera
    examsModal.addEventListener('click', (e) => {
      if (e.target === examsModal) closeExamsModal();
    });

    function openAddExamForm() {
      addExamForm.style.display = 'block';
      populateSubjectSelect();
      // Establecer fecha mÃ­nima a hoy
      const dateInput = document.getElementById('exam-date-input');
      const today = new Date().toISOString().split('T')[0];
      dateInput.min = today;
    }

    function closeAddExamForm() {
      addExamForm.style.display = 'none';
      // Limpiar formulario
      document.getElementById('exam-subject-select').value = '';
      document.getElementById('exam-date-input').value = '';
      document.getElementById('exam-time-input').value = '';
      document.getElementById('exam-location-input').value = '';
    }

    function populateSubjectSelect() {
      const select = document.getElementById('exam-subject-select');
      select.innerHTML = '<option value="">Selecciona una asignatura...</option>';

      if (!currentSemester || !currentSemester.asignaturas) return;

      currentSemester.asignaturas.forEach((asig, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = asig.nombre;
        select.appendChild(option);
      });
    }

    function saveExam() {
      const subjectIndex = document.getElementById('exam-subject-select').value;
      const date = document.getElementById('exam-date-input').value;
      const time = document.getElementById('exam-time-input').value;
      const location = document.getElementById('exam-location-input').value;
      const editingExamId = document.getElementById('exam-date-input').dataset.editingId;

      if (!subjectIndex || !date) {
        alert('Por favor, selecciona una asignatura y una fecha');
        return;
      }

      const subjectName = currentSemester.asignaturas[subjectIndex].nombre;

      let exams = JSON.parse(localStorage.getItem('exams') || '[]');

      if (editingExamId) {
        // Modo ediciÃ³n
        saveStateToHistory('editar examen');
        const examIndex = exams.findIndex(e => e.id == editingExamId);
        if (examIndex !== -1) {
          exams[examIndex] = {
            ...exams[examIndex],
            subjectIndex: parseInt(subjectIndex),
            subjectName: subjectName,
            date: date,
            time: time || '',
            location: location || ''
          };
        }
        delete document.getElementById('exam-date-input').dataset.editingId;
        showSyncIndicator('Examen actualizado correctamente', 'success');
      } else {
        // Modo creaciÃ³n
        const exam = {
          id: Date.now(),
          semesterId: currentSemester.id,
          subjectIndex: parseInt(subjectIndex),
          subjectName: subjectName,
          date: date,
          time: time || '',
          location: location || ''
        };

        saveStateToHistory('aÃ±adir examen');
        exams.push(exam);
        showSyncIndicator('Examen aÃ±adido correctamente', 'success');
      }

      localStorage.setItem('exams', JSON.stringify(exams));

      closeAddExamForm();
      renderExams();
      scheduleSyncToFirebase();
      checkUpcomingExams();
    }

    // Abrir formulario para editar examen
    function openEditExamForm(examId) {
      const allExams = JSON.parse(localStorage.getItem('exams') || '[]');
      const exam = allExams.find(e => e.id == examId);
      if (!exam) return;

      // Abrir modal de exÃ¡menes si no estÃ¡ abierto
      if (!examsModal.classList.contains('show')) {
        openExamsModal();
      }

      // Abrir formulario
      openAddExamForm();

      // Rellenar campos
      document.getElementById('exam-subject-select').value = exam.subjectIndex;
      document.getElementById('exam-date-input').value = exam.date;
      document.getElementById('exam-time-input').value = exam.time || '';
      document.getElementById('exam-location-input').value = exam.location || '';

      // Marcar que estamos editando
      document.getElementById('exam-date-input').dataset.editingId = examId;
    }

    function renderExams() {
      if (!currentSemester) return;

      let allExams = JSON.parse(localStorage.getItem('exams') || '[]');
      // Filtrar exÃ¡menes del cuatrimestre actual
      allExams = allExams.filter(e => e.semesterId === currentSemester.id);

      // Separar futuros y pasados
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const futureExams = [];
      const pastExams = [];

      allExams.forEach(exam => {
        const examDate = new Date(exam.date + 'T00:00:00');
        // Consider today as future
        if (examDate >= today) {
          futureExams.push(exam);
        } else {
          pastExams.push(exam);
        }
      });

      // Ordenar: Futuros ascendente (lo que llega antes primero), Pasados descendente (lo mÃ¡s reciente primero)
      futureExams.sort((a, b) => new Date(a.date) - new Date(b.date));
      pastExams.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Renderizar FUTUROS
      examsList.innerHTML = '';
      if (futureExams.length === 0) {
        noExamsMessage.style.display = 'block';
        if (pastExams.length > 0) noExamsMessage.innerHTML = '<p>âœ… No tienes exÃ¡menes prÃ³ximos</p>';
        else noExamsMessage.innerHTML = '<p>ğŸ“š No hay exÃ¡menes programados</p><p class="hint">AÃ±ade tu primer examen para llevar un seguimiento.</p>';
      } else {
        noExamsMessage.style.display = 'none';
        renderExamListToContainer(futureExams, examsList);
      }

      // Renderizar PASADOS
      const pastSection = document.getElementById('past-exams-section');
      const pastList = document.getElementById('past-exams-list');
      const toggleBtn = document.getElementById('toggle-past-exams');

      if (pastExams.length > 0) {
        pastSection.style.display = 'block';
        pastList.innerHTML = ''; // Limpiar previo
        renderExamListToContainer(pastExams, pastList);

        // Ensure strictly class-based control
        pastList.style.display = 'flex';

        // Inicializar botÃ³n
        toggleBtn.innerHTML = '<span class="icon">â¬‡ï¸</span> Ver ExÃ¡menes Pasados';
        toggleBtn.className = 'btn'; // Reset classes
        toggleBtn.onclick = () => {
          const isExpanded = pastList.classList.contains('expanded');
          if (isExpanded) {
            pastList.classList.remove('expanded');
            toggleBtn.classList.remove('active');
            toggleBtn.innerHTML = '<span class="icon">â¬‡ï¸</span> Ver ExÃ¡menes Pasados';
          } else {
            pastList.classList.add('expanded');
            toggleBtn.classList.add('active');
            toggleBtn.innerHTML = '<span class="icon">â¬‡ï¸</span> Ocultar ExÃ¡menes Pasados';
          }
        };
      } else {
        pastSection.style.display = 'none';
      }
    }

    function renderExamListToContainer(exams, container) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      exams.forEach(exam => {
        const examItem = document.createElement('div');
        examItem.className = 'exam-item';

        const examDate = new Date(exam.date + 'T00:00:00');
        const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));

        let countdownClass = '';
        let countdownText = '';

        if (daysUntil < 0) {
          countdownText = 'Finalizado';
          countdownClass = 'passed'; // Add minimal style if needed
        } else if (daysUntil === 0) {
          countdownText = 'Â¡HOY!';
          countdownClass = 'urgent';
        } else if (daysUntil === 1) {
          countdownText = 'Â¡MAÃ‘ANA!';
          countdownClass = 'urgent';
        } else if (daysUntil <= 7) {
          countdownText = `En ${daysUntil} dÃ­as`;
          countdownClass = 'soon';
        } else {
          countdownText = `En ${daysUntil} dÃ­as`;
        }

        const formattedDate = new Date(exam.date).toLocaleDateString('es-ES', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });

        examItem.innerHTML = `
      <div class="exam-item-header">
        <div class="exam-subject-name">${exam.subjectName}</div>
        <div class="exam-item-actions">
          <button class="exam-edit-btn" onclick="openEditExamForm(${exam.id})">Editar</button>
          <button class="exam-delete-btn" onclick="deleteExam(${exam.id})">Eliminar</button>
        </div>
      </div>
      <div class="exam-details">
        <div class="exam-detail-item">
          <span>ğŸ“…</span>
          <span>${formattedDate}</span>
        </div>
        ${exam.time ? `
        <div class="exam-detail-item">
          <span>ğŸ•</span>
          <span>${exam.time}</span>
        </div>` : ''}
        ${exam.location ? `
        <div class="exam-detail-item">
          <span>ğŸ“</span>
          <span>${exam.location}</span>
        </div>` : ''}
      </div>
      ${daysUntil >= 0 ? `<div class="exam-countdown ${countdownClass}">${countdownText}</div>` : ''}
    `;
        container.appendChild(examItem);
      });
    }

    function deleteExam(examId) {
      if (!confirm('Â¿Eliminar este examen?')) return;

      saveStateToHistory('eliminar examen');
      let exams = JSON.parse(localStorage.getItem('exams') || '[]');
      exams = exams.filter(e => e.id !== examId);
      localStorage.setItem('exams', JSON.stringify(exams));

      renderExams();
      scheduleSyncToFirebase(); // Sincronizar con la nube
      showSyncIndicator('Examen eliminado', 'success');
      // Actualizar avisos en menÃº principal
      if (menuScreen.classList.contains('active')) {
        checkUpcomingExams();
      }
    }

    /* -------------------------
       AVISOS DE EXÃMENES EN MENÃš PRINCIPAL - REDISEÃ‘O
       ------------------------- */
    function checkUpcomingExams() {
      const alertContainer = document.getElementById('upcoming-exams-alert');
      if (!alertContainer) return;

      const allExams = JSON.parse(localStorage.getItem('exams') || '[]');
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Filtrar exÃ¡menes prÃ³ximos (dentro de los prÃ³ximos 7 dÃ­as)
      const upcomingExams = allExams.filter(exam => {
        const examDate = new Date(exam.date + 'T00:00:00');
        const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
        return daysUntil >= 0 && daysUntil <= 7;
      });

      // LÃ“GICA DE NOTIFICACIONES LOCALES
      if ('Notification' in window && Notification.permission === 'granted') {
        const notifiedExams = JSON.parse(localStorage.getItem('notifiedExams') || '{}');
        const nowStr = new Date().toDateString();

        upcomingExams.forEach(exam => {
          const examDate = new Date(exam.date + 'T00:00:00');
          const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));

          // Notificar si es maÃ±ana (1 dÃ­a) o hoy (0 dÃ­as) y no se ha notificado hoy
          if ((daysUntil === 0 || daysUntil === 1) && notifiedExams[exam.id] !== nowStr) {
            const baseTitle = daysUntil === 0 ? 'Â¡Examen HOY!' : 'Â¡Examen MAÃ‘ANA!';
            const body = `Tienes examen de ${exam.subjectName} ${daysUntil === 0 ? 'hoy' : 'maÃ±ana'}. Â¡Mucho Ã©xito!`;

            try {
              new Notification(baseTitle, {
                body: body,
                tag: 'exam-' + exam.id
              });
            } catch (e) { console.log('Error notificaciÃ³n:', e); }

            // Marcar como notificado hoy
            notifiedExams[exam.id] = nowStr;
          }
        });
        localStorage.setItem('notifiedExams', JSON.stringify(notifiedExams));
      }

      if (upcomingExams.length === 0) {
        alertContainer.style.display = 'none';
        return;
      }

      // Ordenar por fecha
      upcomingExams.sort((a, b) => new Date(a.date) - new Date(b.date));

      // Mostrar todos los exÃ¡menes prÃ³ximos (sin lÃ­mite)
      const examsToShow = upcomingExams;

      // Construir HTML del aviso
      let alertHTML = '<div class="exam-alerts-header"><span class="ai-icon">âš ï¸</span><span>';

      if (examsToShow.length === 1) {
        alertHTML += 'Tienes 1 examen prÃ³ximo';
      } else {
        alertHTML += `Tienes ${examsToShow.length} exÃ¡menes prÃ³ximos`;
      }

      alertHTML += '</span></div><div class="exam-alerts-list">';

      examsToShow.forEach(exam => {
        const examDate = new Date(exam.date + 'T00:00:00');
        const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));

        let urgencyClass = '';
        let timeText = '';

        if (daysUntil === 0) {
          urgencyClass = 'urgent';
          timeText = 'Â¡HOY!';
        } else if (daysUntil === 1) {
          urgencyClass = 'urgent';
          timeText = 'Â¡MAÃ‘ANA!';
        } else if (daysUntil <= 3) {
          urgencyClass = 'soon';
          timeText = `En ${daysUntil} dÃ­as`;
        } else {
          timeText = `En ${daysUntil} dÃ­as`;
        }

        const formattedDate = examDate.toLocaleDateString('es-ES', {
          day: 'numeric',
          month: 'short'
        });

        alertHTML += `
      <div class="exam-alert-item ${urgencyClass}" onclick="openExamDetailModal('${exam.id}')">
        <div class="exam-alert-subject">${exam.subjectName}</div>
        <div class="exam-alert-time">${timeText}</div>
        <div class="exam-alert-date">${formattedDate}</div>
      </div>
    `;
      });

      alertHTML += '</div>';

      alertContainer.innerHTML = alertHTML;
      alertContainer.style.display = 'block';
    }

    // Abrir modal de detalles del examen
    function openExamDetailModal(examId) {
      // Obtener exÃ¡menes de localStorage
      const allExams = JSON.parse(localStorage.getItem('exams') || '[]');
      const exam = allExams.find(e => e.id == examId);
      if (!exam) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const examDate = new Date(exam.date + 'T00:00:00');
      const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));

      let urgencyClass = '';
      let timeText = '';

      if (daysUntil === 0) {
        urgencyClass = 'urgent';
        timeText = 'Â¡HOY!';
      } else if (daysUntil === 1) {
        urgencyClass = 'urgent';
        timeText = 'Â¡MAÃ‘ANA!';
      } else if (daysUntil <= 3) {
        urgencyClass = 'soon';
        timeText = `En ${daysUntil} dÃ­as`;
      } else {
        timeText = `En ${daysUntil} dÃ­as`;
      }

      const formattedDate = examDate.toLocaleDateString('es-ES', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });

      const formattedTime = exam.time || 'No especificada';
      const location = exam.location || 'No especificada';

      const detailContent = document.getElementById('exam-detail-content');
      detailContent.innerHTML = `
    <div class="exam-detail-item">
      <div class="exam-detail-label">Asignatura</div>
      <div class="exam-detail-value large">${exam.subjectName}</div>
    </div>
    
    <div class="exam-detail-item">
      <div class="exam-detail-label">Fecha</div>
      <div class="exam-detail-value">${formattedDate}</div>
    </div>
    
    <div class="exam-detail-item">
      <div class="exam-detail-label">Hora</div>
      <div class="exam-detail-value">${formattedTime}</div>
    </div>
    
    <div class="exam-detail-item">
      <div class="exam-detail-label">UbicaciÃ³n</div>
      <div class="exam-detail-value">${location}</div>
    </div>
    
    <div class="exam-detail-item">
      <div class="exam-detail-label">Tiempo restante</div>
      <div class="exam-detail-value ${urgencyClass}">${timeText}</div>
    </div>
    
    <div class="exam-detail-actions">
      <button class="btn btn-delete" onclick="deleteExamFromDetail('${exam.id}')">ğŸ—‘ï¸ Eliminar</button>
      <button class="btn btn-close" onclick="closeExamDetailModal()">Cerrar</button>
    </div>
  `;

      const modal = document.getElementById('exam-detail-modal');
      modal.style.display = 'flex';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    // Cerrar modal de detalles del examen
    function closeExamDetailModal() {
      const modal = document.getElementById('exam-detail-modal');
      modal.classList.remove('show');
      setTimeout(() => modal.style.display = 'none', 250);
    }

    // Eliminar examen desde el modal de detalles
    function deleteExamFromDetail(examId) {
      if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar este examen?')) {
        saveStateToHistory('eliminar examen');
        let allExams = JSON.parse(localStorage.getItem('exams') || '[]');
        allExams = allExams.filter(e => e.id != examId);
        localStorage.setItem('exams', JSON.stringify(allExams));
        closeExamDetailModal();
        checkUpcomingExams();
        showSyncIndicator('Examen eliminado correctamente', 'success');
        scheduleSyncToFirebase();
      }
    }

    // Generar PDF
    async function generatePDF() {
      const progressDiv = document.getElementById('export-progress');
      progressDiv.style.display = 'flex';

      // Opciones seleccionadas
      const options = {
        cover: document.getElementById('export-cover').checked,
        stats: document.getElementById('export-stats').checked,
        charts: document.getElementById('export-charts').checked,
        subjects: document.getElementById('export-subjects').checked,
        recommendations: document.getElementById('export-recommendations').checked,
        title: document.getElementById('export-title-text').value || 'Informe AcadÃ©mico'
      };

      try {
        // Cargar jsPDF desde CDN
        if (typeof window.jspdf === 'undefined') {
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        let yPos = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;
        const maxWidth = pageWidth - (margin * 2);

        // FunciÃ³n para verificar espacio y aÃ±adir nueva pÃ¡gina
        const checkSpace = (needed) => {
          if (yPos + needed > pageHeight - 20) {
            doc.addPage();
            yPos = 20;
            return true;
          }
          return false;
        };

        // PORTADA
        if (options.cover) {
          doc.setFillColor(99, 102, 241);
          doc.rect(0, 0, pageWidth, 80, 'F');

          doc.setTextColor(255, 255, 255);
          doc.setFontSize(28);
          doc.setFont(undefined, 'bold');
          doc.text('StudyBoard', pageWidth / 2, 35, { align: 'center' });

          doc.setFontSize(20);
          doc.setFont(undefined, 'normal');
          doc.text(options.title, pageWidth / 2, 55, { align: 'center' });

          doc.setTextColor(0, 0, 0);
          yPos = 100;

          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}`, margin, yPos);
          yPos += 10;
          doc.text(`Cuatrimestre: ${currentSemester ? currentSemester.nombre : 'N/A'}`, margin, yPos);
          yPos += 20;
        }

        // ESTADÃSTICAS GENERALES
        if (options.stats && currentSemester) {
          checkSpace(60);

          doc.setFontSize(16);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(99, 102, 241);
          doc.text('Estadisticas Generales', margin, yPos);
          yPos += 10;

          const cards = Array.from(document.querySelectorAll('.card:not(.drag-preview)'));
          const subjects = cards.map(card => {
            const gradeText = calcularNotaAsignatura(card);
            return gradeText !== '-' ? parseFloat(gradeText) : 0;
          }).filter(g => g > 0);

          const average = subjects.length > 0
            ? (subjects.reduce((a, b) => a + b, 0) / subjects.length).toFixed(2)
            : 'N/A';
          const passed = subjects.filter(g => g >= 5).length;
          const failed = subjects.filter(g => g > 0 && g < 5).length;
          const totalEcts = passed * 6;

          doc.setTextColor(0, 0, 0);
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');

          const stats = [
            `Total de asignaturas: ${cards.length}`,
            `Promedio general: ${average}`,
            `Asignaturas aprobadas: ${passed}`,
            `Asignaturas suspendidas: ${failed}`,
            `ECTS obtenidos: ${totalEcts}`
          ];

          stats.forEach(stat => {
            checkSpace(8);
            doc.text(`- ${stat}`, margin + 5, yPos);
            yPos += 8;
          });

          yPos += 10;
        }

        // GRÃFICOS (versiÃ³n texto)
        if (options.charts && currentSemester) {
          checkSpace(70);

          doc.setFontSize(16);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(99, 102, 241);
          doc.text('Distribucion de Notas', margin, yPos);
          yPos += 10;

          const cards = Array.from(document.querySelectorAll('.card:not(.drag-preview)'));
          const grades = cards.map(card => {
            const gradeText = calcularNotaAsignatura(card);
            return gradeText !== '-' ? parseFloat(gradeText) : 0;
          }).filter(g => g > 0);

          const distribution = {
            'Suspensos (0-5)': grades.filter(g => g < 5).length,
            'Aprobados (5-7)': grades.filter(g => g >= 5 && g < 7).length,
            'Notables (7-9)': grades.filter(g => g >= 7 && g < 9).length,
            'Sobresalientes (9-10)': grades.filter(g => g >= 9).length
          };

          doc.setTextColor(0, 0, 0);
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');

          Object.entries(distribution).forEach(([range, count]) => {
            checkSpace(8);
            const percentage = grades.length > 0 ? ((count / grades.length) * 100).toFixed(0) : 0;
            doc.text(`${range}: ${count} (${percentage}%)`, margin + 5, yPos);
            yPos += 8;
          });

          yPos += 10;
        }

        // DETALLE POR ASIGNATURA
        if (options.subjects && currentSemester) {
          checkSpace(30);

          doc.setFontSize(16);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(99, 102, 241);
          doc.text('Detalle por Asignatura', margin, yPos);
          yPos += 10;

          const cards = Array.from(document.querySelectorAll('.card:not(.drag-preview)'));

          cards.forEach((card, index) => {
            checkSpace(35);

            const name = card.querySelector('.titulo').textContent;
            const gradeText = calcularNotaAsignatura(card);
            const grade = gradeText !== '-' ? parseFloat(gradeText) : 0;

            // Calcular progreso
            let progress = 0;
            if (card._tests && card._tests.length > 0) {
              card._tests.forEach(t => {
                progress += parseFloat(t.ponderacion) || 0;
              });
            }
            progress = Math.min(100, progress);

            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text(`${index + 1}. ${name}`, margin, yPos);
            yPos += 7;

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');

            let status = '';
            if (grade >= 9) status = '[Excelente]';
            else if (grade >= 7) status = '[Notable]';
            else if (grade >= 5) status = '[Aprobado]';
            else if (grade > 0) status = '[Suspenso]';

            doc.text(`   Nota: ${gradeText} ${status}`, margin, yPos);
            yPos += 6;
            doc.text(`   Progreso evaluado: ${progress.toFixed(0)}%`, margin, yPos);
            yPos += 10;
          });
        }

        // RECOMENDACIONES IA
        if (options.recommendations) {
          checkSpace(40);

          doc.setFontSize(16);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(99, 102, 241);
          doc.text('Recomendaciones IA', margin, yPos);
          yPos += 10;

          const aiText = document.getElementById('ai-recommendation-text');
          if (aiText && aiText.textContent) {
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');

            const lines = doc.splitTextToSize(aiText.textContent, maxWidth);
            lines.forEach(line => {
              checkSpace(7);
              doc.text(line, margin, yPos);
              yPos += 7;
            });
          } else {
            doc.setTextColor(128, 128, 128);
            doc.setFontSize(11);
            doc.text('No hay recomendaciones disponibles.', margin, yPos);
          }
        }

        // Pie de pÃ¡gina en todas las pÃ¡ginas
        const totalPages = doc.internal.pages.length - 1;
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(9);
          doc.setTextColor(128, 128, 128);
          doc.text(`Generado con StudyBoard - PÃ¡gina ${i} de ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
        }

        // Guardar PDF
        const fileName = `${options.title.replace(/[^a-z0-9]/gi, '_')}.pdf`;
        doc.save(fileName);

        progressDiv.style.display = 'none';
        closeExportModal();

        // Mostrar notificaciÃ³n de Ã©xito
        showSyncIndicator('PDF generado correctamente', 'success');

      } catch (error) {
        console.error('Error generando PDF:', error);
        progressDiv.style.display = 'none';
        alert('Error al generar el PDF. Por favor, intÃ©ntalo de nuevo.');
      }
    }

    /* -------------------------
       EXPORTAR ICS (Calendario)
       ------------------------- */
    function generateAndDownloadICS() {
      if (!currentSemester) return;
      let exams = JSON.parse(localStorage.getItem('exams') || '[]');
      // Filtrar por cuatrimestre actual
      exams = exams.filter(e => e.semesterId === currentSemester.id);

      if (exams.length === 0) {
        alert('No hay exÃ¡menes para exportar en este cuatrimestre.');
        return;
      }

      let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//StudyBoard//Exams//ES\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";

      exams.forEach(exam => {
        const cleanDate = exam.date.replace(/-/g, ''); // YYYYMMDD
        // Hora por defecto 09:00 si no existe
        let startTime = exam.time ? exam.time.replace(/:/g, '') + '00' : '090000';

        // Formato: YYYYMMDDTHHmmss
        let dtStart = `${cleanDate}T${startTime}`;

        // DuraciÃ³n estimada: 2 horas por defecto
        let hour = parseInt(startTime.substring(0, 2));
        let endHour = hour + 2;
        let endTime = (endHour < 10 ? '0' : '') + endHour + startTime.substring(2);

        let dtEnd = `${cleanDate}T${endTime}`;

        icsContent += "BEGIN:VEVENT\n";
        icsContent += `DTSTART:${dtStart}\n`;
        icsContent += `DTEND:${dtEnd}\n`;
        icsContent += `SUMMARY:Examen ${exam.subjectName}\n`;
        icsContent += `DESCRIPTION:Examen de ${exam.subjectName}\\nStudyBoard\n`;
        if (exam.location) icsContent += `LOCATION:${exam.location}\n`;
        icsContent += `UID:${exam.id}@studyboard.app\n`;
        icsContent += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
        icsContent += "END:VEVENT\n";
      });

      icsContent += "END:VCALENDAR";

      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.setAttribute('download', `studyboard_exams_${currentSemester.id}.ics`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // FunciÃ³n auxiliar para cargar scripts dinÃ¡micamente
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    /* -------------------------
       SERVICE WORKER (PWA)
       ------------------------- */

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/studyboard/sw.js')
          .then((registration) => {
            console.log('âœ… Service Worker registrado:', registration.scope);

            // Forzar actualizaciÃ³n si hay un SW esperando
            if (registration.waiting) {
              registration.waiting.postMessage({ type: 'SKIP_WAITING' });
            }

            // Actualizar cuando haya un nuevo SW
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Nuevo SW instalado, recargar para usar la nueva versiÃ³n
                  console.log('Nueva versiÃ³n disponible, recargando...');
                  window.location.reload();
                }
              });
            });
          })
          .catch((error) => {
            console.log('âŒ Error al registrar Service Worker:', error);
          });
      });

      // Escuchar peticiones de widget data desde el Service Worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'GET_WIDGET_DATA') {
          const widgetData = generateWidgetDataForSW();
          event.ports[0].postMessage(widgetData);
        }
      });

      // Recargar cuando el SW tome control
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }

    // Generar datos para el widget
    function generateWidgetDataForSW() {
      try {
        const cuatrimestres = JSON.parse(localStorage.getItem('cuatrimestres')) || [];
        const exams = JSON.parse(localStorage.getItem('exams')) || [];

        // Obtener cuatrimestre actual (Ãºltimo no archivado)
        const currentSemester = cuatrimestres.find(c => !c.archived) || cuatrimestres[0];

        if (!currentSemester || !currentSemester.asignaturas) {
          return {
            average: "-",
            subjects: 0,
            ects: 0,
            nextExam: null,
            timestamp: new Date().toISOString()
          };
        }

        // Calcular media
        const subjects = currentSemester.asignaturas;
        const gradesOnly = subjects
          .map(s => {
            const tests = s.tests || [];
            if (tests.length === 0) return 0;

            let suma = 0;
            let totalPonderacion = 0;
            tests.forEach(t => {
              const nota = parseFloat(t.nota) || 0;
              const ponderacion = parseFloat(t.ponderacion) || 0;
              suma += nota * ponderacion;
              totalPonderacion += ponderacion;
            });

            return totalPonderacion > 0 ? suma / 100 : 0;
          })
          .filter(g => g > 0);

        const average = gradesOnly.length > 0
          ? (gradesOnly.reduce((a, b) => a + b, 0) / gradesOnly.length).toFixed(1)
          : "-";

        // ECTS aprobados
        const passed = subjects.filter(s => {
          const tests = s.tests || [];
          if (tests.length === 0) return false;

          let suma = 0;
          let totalPonderacion = 0;
          tests.forEach(t => {
            const nota = parseFloat(t.nota) || 0;
            const ponderacion = parseFloat(t.ponderacion) || 0;
            suma += nota * ponderacion;
            totalPonderacion += ponderacion;
          });

          const notaFinal = totalPonderacion > 0 ? suma / 100 : 0;
          return notaFinal >= 5;
        }).length;

        const ects = passed * 6;

        // PrÃ³ximo examen
        const now = new Date();
        const upcomingExams = exams
          .map(exam => {
            const examDate = new Date(exam.fecha + 'T' + (exam.hora || '00:00'));
            const daysLeft = Math.ceil((examDate - now) / (1000 * 60 * 60 * 24));
            return { ...exam, examDate, daysLeft };
          })
          .filter(e => e.daysLeft >= 0)
          .sort((a, b) => a.examDate - b.examDate);

        const nextExam = upcomingExams.length > 0 ? {
          subject: upcomingExams[0].asignatura,
          date: new Date(upcomingExams[0].fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }),
          daysLeft: upcomingExams[0].daysLeft
        } : null;

        return {
          average,
          subjects: subjects.length,
          ects,
          nextExam,
          timestamp: new Date().toISOString()
        };
      } catch (err) {
        console.error('Error generando widget data:', err);
        return {
          average: "-",
          subjects: 0,
          ects: 0,
          nextExam: null,
          timestamp: new Date().toISOString()
        };
      }
    }

    // Detectar instalaciÃ³n de PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('ğŸ’¡ App lista para instalar');
    });

    // Detectar cuando se instala
    window.addEventListener('appinstalled', () => {
      console.log('âœ… App instalada correctamente');
      deferredPrompt = null;
    });

  </script>

</body>

</html>